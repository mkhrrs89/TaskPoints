<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>TaskPoints — Week</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><circle cx='50' cy='50' r='48' fill='%230b0d10'/><text x='50' y='62' font-size='60' text-anchor='middle' fill='white'>TP</text></svg>">
<script src="https://cdn.tailwindcss.com"></script>


<link rel="stylesheet" href="styles.css">
<script src="scoring_core.js"></script>
<script src="toolbar.js" defer></script>


  <style>
    :root{--bg:#0b0d10;--border:#202830;--muted:#8b98a5}
    body{background:var(--bg);color:#e6edf6}
    @media (prefers-color-scheme:light){body{background:#fafafa;color:#0b1220}}
    .glass{border:1px solid var(--border);background:rgba(255,255,255,.06);border-radius:16px;padding:16px}
    @media (prefers-color-scheme:light){.glass{background:#fff;border-color:#e5e7eb}}
    .btn{border:1px solid var(--border);border-radius:12px;padding:6px 8px;font-size:11px}
    .btn-ghost{background:transparent}
    .btn-success{background:#22c55e;color:#072;border:none}
.btn-warn {
  background: rgba(217, 119, 6, 0.25);   /* amber-700 muted */
  border: 1px solid rgba(217, 119, 6, 0.35);
  color: #b45309;                        /* amber-700 text */
}

    .btn-deny{background:#ef4444;color:#fff;border:none}
    .btn-nav{background:transparent;color:var(--muted)}
    .btn-nav-primary{background:#1f2937;color:#e5e7eb;border:none}
    .btn-teal {background: linear-gradient(180deg, #0f4d4d, #0a2f2f);color: #fff;border: none;}
/* --- Teal Nav Buttons (match main page) --- */
.top-nav-btn{
  border-radius:999px;
  padding:6px 10px;
  font-size:11px;
  border:1px solid rgba(75,85,99,0.7);
  background:rgba(17,25,33,0.8);
  color:#dbeafe;
}
@media (prefers-color-scheme: light){
  .top-nav-btn{
    background:rgba(240,245,255,0.8);
    color:#1e293b;
    border-color:rgba(148,163,184,0.8);
  }
}
.top-nav-btn-active{
  background:rgba(12,84,96,0.75);
  color:white;
  border:none;
}

    .muted{color:var(--muted)}
    .grid7{
      display:flex;
      flex-wrap:nowrap;
      gap:.75rem;
      overflow-x:auto;
      padding-bottom:10px;
      scroll-snap-type:x proximity;
      scrollbar-gutter:stable;
    }
    .grid7 .slot{
      flex:0 0 clamp(280px, 32vw, 360px);
      min-height:72px;
      border:1px dashed var(--border);
      border-radius:12px;
      padding:10px;
      scroll-snap-align:start;
      background:rgba(255,255,255,.02);
    }
    .task{
      border:1px solid var(--border);
      border-radius:10px;
      padding:10px;
      margin-bottom:8px;
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .task.critical-card{
      background: linear-gradient(
        180deg,
        rgba(110, 32, 36, 0.26),
        rgba(78, 20, 24, 0.18)
      ) !important;
      border-color: #4f1f23 !important;
    }
    .task.high-card{
      background: linear-gradient(
        180deg,
        rgba(120, 52, 4, 0.07),
        rgba(90, 35, 6, 0.05)
      ) !important;
      border-color: #30180C !important;
    }
    @media (max-width: 640px){
      .grid7 .slot{
        flex-basis: clamp(260px, 82vw, 320px);
      }
    }


    .habitRow{display:grid;grid-template-columns:1fr repeat(7,40px);gap:.65rem;align-items:center}
    .habitScroll{overflow-x:auto;padding-bottom:8px}
    .habitScroll .habitRow{min-width:560px}
    @media (max-width:640px){
      .habitRow{grid-template-columns:minmax(140px,1fr) repeat(7,minmax(32px,1fr));gap:.5rem}
      .habitScroll .habitRow{min-width:520px}
    }
    .habitDay{width:40px;height:38px;border-radius:10px;border:1px solid var(--border);display:grid;place-items:center;font-size:12px;cursor:pointer}
    .habitDay.on{background:#3D1C0B;border-color:#fb923c}
  </style>
</head>
<body class="min-h-screen">
  <div class="mx-auto max-w-6xl p-4 sm:p-6">

<div class="flex items-center justify-between gap-3 mb-3 md:hidden">
  <a href="index.html" class="flex items-center gap-3">
    <img src="assets/taskpoints-logo.png" alt="TaskPoints logo" class="w-10 h-10 rounded-2xl object-cover shrink-0 shadow-sm">
    <h1 class="text-2xl font-extrabold tracking-tight leading-tight">
      <span style="color:#fb923c;">Task</span><span style="color:#1e666d;">Points</span>
    </h1>
  </a>
  <div class="flex items-center gap-2">
    <button type="button" class="btn btn-ghost btn-toolbar" data-export-button>Export</button>
    <label class="btn btn-ghost btn-toolbar cursor-pointer">
      <span>Import</span>
      <input type="file" accept="application/json" class="hidden" data-import-input/>
    </label>
  </div>
</div>

<header class="flex items-center justify-between mb-4 gap-3 flex-wrap">
  <h1 class="text-2xl font-extrabold page-title">Week</h1>
  <div class="toolbar header-nav">
    <a href="index.html"         class="btn btn-teal btn-toolbar nav-btn">Main</a>
    <a href="daily_sources.html" class="btn btn-teal btn-toolbar nav-btn">Sources</a>
    <a href="log.html"           class="btn btn-teal btn-toolbar nav-btn">Log</a>
    <a href="week.html"          class="btn btn-teal btn-toolbar nav-btn active" aria-current="page">Week</a>
    <div class="dropdown">
      <button type="button" class="btn btn-teal btn-toolbar nav-btn dropdown-toggle" data-dropdown-toggle aria-expanded="false">Game <span class="caret">▾</span></button>
      <div class="dropdown-menu">
        <a href="gamehub.html" class="btn btn-teal btn-toolbar nav-btn">Game Hub</a>
        <a href="game.html"         class="btn btn-teal btn-toolbar nav-btn">Players</a>
        <a href="standings.html"    class="btn btn-teal btn-toolbar nav-btn">Standings</a>
        <a href="matchups.html"     class="btn btn-teal btn-toolbar nav-btn">Matchups</a>
        <a href="schedule.html"     class="btn btn-teal btn-toolbar nav-btn">Schedule</a>
        <a href="game_ratings.html" class="btn btn-teal btn-toolbar nav-btn">Ratings</a>
        <a href="records.html"      class="btn btn-teal btn-toolbar nav-btn">Records</a>
      </div>
    </div>
    <a href="projects.html" class="btn btn-teal btn-toolbar nav-btn">Projects</a>
    <a href="settings.html" class="btn btn-teal btn-toolbar nav-btn">Settings</a>


  </div>
</header>


      <!-- Tasks -->
      <div class="glass mb-6">
      <div class="flex items-start justify-between gap-3 mb-3">
        <h2 class="font-bold">Tasks (this week view)</h2>
        <div class="flex gap-1 text-xs whitespace-nowrap items-center flex-wrap justify-end">
          <button id="openAddTaskBtn" class="btn btn-primary">Add Task</button>
          <button data-week-nav="prev" class="btn btn-ghost btn-toolbar">← Prev</button>
          <button data-week-nav="this" class="btn btn-ghost btn-toolbar">This Week</button>
          <button data-week-nav="next" class="btn btn-ghost btn-toolbar">Next →</button>
        </div>
      </div>
      <div id="weekGrid" class="grid7"></div>
    </div>

    <!-- Habits -->
    <div class="glass mb-6">
      <div class="flex items-start justify-between gap-3 mb-2">
        <h2 class="font-bold">Habits (week of <span id="weekLabel"></span>)</h2>
        <div class="flex gap-1 text-xs whitespace-nowrap">
          <button data-week-nav="prev" class="btn btn-ghost btn-toolbar">← Prev</button>
          <button data-week-nav="this" class="btn btn-ghost btn-toolbar">This Week</button>
          <button data-week-nav="next" class="btn btn-ghost btn-toolbar">Next →</button>
        </div>
      </div>
      <div class="grid gap-2 text-sm muted mb-2 habitScroll" id="habitWeekLabels"></div>
      <div id="habitsList" class="grid gap-2 habitScroll"></div>
      <div id="habitsEmpty" class="muted text-sm">No habits yet.</div>
    </div>

    <div class="glass mb-6">
      <div class="flex items-start justify-between gap-3 mb-2">
        <h2 class="font-bold">Vices (week of <span id="vicesWeekLabel"></span>)</h2>
        <div class="flex gap-1 text-xs whitespace-nowrap">
          <button data-week-nav="prev" class="btn btn-ghost btn-toolbar">← Prev</button>
          <button data-week-nav="this" class="btn btn-ghost btn-toolbar">This Week</button>
          <button data-week-nav="next" class="btn btn-ghost btn-toolbar">Next →</button>
        </div>
      </div>
      <div class="grid gap-2 text-sm muted mb-2 habitScroll" id="vicesWeekLabels"></div>
      <div id="vicesList" class="grid gap-2 habitScroll"></div>
      <div id="vicesEmpty" class="muted text-sm">No vices yet.</div>
    </div>

    <div class="glass mb-6">
      <div class="flex items-start justify-between gap-3 mb-2">
        <h2 class="font-bold">Retired (week of <span id="retiredWeekLabel"></span>)</h2>
        <div class="flex gap-1 text-xs whitespace-nowrap">
          <button data-week-nav="prev" class="btn btn-ghost btn-toolbar">← Prev</button>
          <button data-week-nav="this" class="btn btn-ghost btn-toolbar">This Week</button>
          <button data-week-nav="next" class="btn btn-ghost btn-toolbar">Next →</button>
        </div>
      </div>
      <div class="grid gap-2 text-sm muted mb-2 habitScroll" id="retiredWeekLabels"></div>
      <div id="retiredList" class="grid gap-2 habitScroll"></div>
      <div id="retiredEmpty" class="muted text-sm">No retired habits or vices.</div>
    </div>

    <!-- Flex Actions (this week) -->
    <div class="glass mb-6">
      <div class="flex items-start justify-between gap-3 mb-2">
        <h2 class="font-bold">Flex Actions (this week)</h2>
        <div class="flex gap-1 text-xs whitespace-nowrap">
          <button data-week-nav="prev" class="btn btn-ghost btn-toolbar">← Prev</button>
          <button data-week-nav="this" class="btn btn-ghost btn-toolbar">This Week</button>
          <button data-week-nav="next" class="btn btn-ghost btn-toolbar">Next →</button>
        </div>
      </div>
      <div id="flexWeekList" class="grid gap-2 text-sm"></div>
      <div id="flexWeekEmpty" class="muted text-sm">No flex actions logged this week.</div>
    </div>

    <!-- Retired Flex Actions -->
    <div class="glass mb-6">
      <div class="flex items-start justify-between gap-3 mb-2">
        <h2 class="font-bold">Retired Flex Actions</h2>
      </div>
      <div id="retiredFlexList" class="grid gap-2 text-sm"></div>
      <div id="retiredFlexEmpty" class="muted text-sm">No retired flex actions.</div>
    </div>

<!-- Work Scores (this week) -->
<div class="glass mb-6">
  <div class="flex items-start justify-between gap-3 mb-2">
    <h2 class="font-bold">Work Scores (this week)</h2>
    <div class="flex gap-1 text-xs whitespace-nowrap">
      <button data-week-nav="prev" class="btn btn-ghost btn-toolbar">← Prev</button>
      <button data-week-nav="this" class="btn btn-ghost btn-toolbar">This Week</button>
      <button data-week-nav="next" class="btn btn-ghost btn-toolbar">Next →</button>
    </div>
  </div>
  <div id="workWeekList" class="grid gap-2 text-sm"></div>
  <div id="workWeekEmpty" class="muted text-sm">No work scores yet this week.</div>
</div>

<!-- Sleep Scores (this week) -->
<div class="glass mb-6">
  <div class="flex items-start justify-between gap-3 mb-2">
    <h2 class="font-bold">Sleep Scores (this week)</h2>
    <div class="flex gap-1 text-xs whitespace-nowrap">
      <button data-week-nav="prev" class="btn btn-ghost btn-toolbar">← Prev</button>
      <button data-week-nav="this" class="btn btn-ghost btn-toolbar">This Week</button>
      <button data-week-nav="next" class="btn btn-ghost btn-toolbar">Next →</button>
    </div>
  </div>
  <div id="sleepWeekList" class="grid gap-2 text-sm"></div>
  <div id="sleepWeekEmpty" class="muted text-sm">No sleep scores yet this week.</div>
</div>

<!-- Calories (this week) -->
<div class="glass mb-6">
  <div class="flex items-start justify-between gap-3 mb-2">
    <h2 class="font-bold">Calories (this week)</h2>
    <div class="flex gap-1 text-xs whitespace-nowrap">
      <button data-week-nav="prev" class="btn btn-ghost btn-toolbar">← Prev</button>
      <button data-week-nav="this" class="btn btn-ghost btn-toolbar">This Week</button>
      <button data-week-nav="next" class="btn btn-ghost btn-toolbar">Next →</button>
    </div>
  </div>
  <div id="caloriesWeekList" class="grid gap-2 text-sm"></div>
  <div id="caloriesWeekEmpty" class="muted text-sm">No calories logged this week.</div>
</div>

<!-- Mood Scores (this week) -->
<div class="glass mb-6">
  <div class="flex items-start justify-between gap-3 mb-2">
    <h2 class="font-bold">Mood Scores (this week)</h2>
    <div class="flex gap-1 text-xs whitespace-nowrap">
      <button data-week-nav="prev" class="btn btn-ghost btn-toolbar">← Prev</button>
      <button data-week-nav="this" class="btn btn-ghost btn-toolbar">This Week</button>
      <button data-week-nav="next" class="btn btn-ghost btn-toolbar">Next →</button>
    </div>
  </div>
  <div id="moodWeekList" class="grid gap-2 text-sm"></div>
  <div id="moodWeekEmpty" class="muted text-sm">No mood scores yet this week.</div>
</div>


    <footer class="mt-10 text-xs muted flex items-center justify-between">
      <span>Use Previous/Next to browse habit history. Click a habit day to toggle; postpone moves overdue tasks to today; “Won’t do” drops just that instance for repeaters.</span>
      <span>v0.24.0 — 2025-11-13 11:15</span>
    </footer>
  </div>

<script>
const STORAGE_KEY="taskpoints_v1";
const $=id=>document.getElementById(id);

function load() {
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (!raw) {
      return {
        tasks:       [],
        completions: [],
        players:     [],
        habits:      [],
        flexActions: [],
        matchups:    [],
        gameHistory: [],
        workHistory: [],
        schedule:    []
      };
    }

    const p = JSON.parse(raw) || {};
    return {
      tasks:       Array.isArray(p.tasks)       ? p.tasks       : [],
      completions: Array.isArray(p.completions) ? p.completions : [],
      players:     Array.isArray(p.players)     ? p.players     : [],
      habits:      Array.isArray(p.habits)      ? p.habits      : [],
      flexActions: Array.isArray(p.flexActions) ? p.flexActions : [],
      matchups:    Array.isArray(p.matchups)    ? p.matchups    : [],
      gameHistory: Array.isArray(p.gameHistory) ? p.gameHistory : [],
      workHistory: Array.isArray(p.workHistory) ? p.workHistory : [],
      schedule:    Array.isArray(p.schedule)    ? p.schedule    : [],
      opponentDripSchedules: Array.isArray(p.opponentDripSchedules) ? p.opponentDripSchedules : []
    };
  } catch (e) {
    console.error("week load error", e);
    return {
      tasks:       [],
      completions: [],
      players:     [],
      habits:      [],
      flexActions: [],
      matchups:    [],
      gameHistory: [],
      workHistory: [],
      schedule:    [],
      opponentDripSchedules: []
    };
  }
}


let state = load();
let currentBaseDate = new Date();

syncDerivedPointsIfNeeded();

  function normalizeHexColor(value) {
    if (!value) return null;
    let hex = String(value).trim();
    if (!hex) return null;
    if (!hex.startsWith('#')) hex = `#${hex}`;
    if (!/^#([0-9a-fA-F]{3}|[0-9a-fA-F]{6})$/.test(hex)) return null;
    if (hex.length === 4) {
      hex = `#${hex.slice(1).split('').map((c) => c + c).join('')}`;
    }
    return hex.toLowerCase();
  }

  function normalizeHabitTagColors(value) {
    if (!value || typeof value !== 'object') return {};
    const next = {};
    Object.entries(value).forEach(([tag, color]) => {
      const normalized = normalizeHexColor(color);
      if (normalized) next[String(tag)] = normalized;
    });
    return next;
  }

  function normalizeHabit(habit) {
    if (!habit || typeof habit !== 'object') return habit;
    return {
      ...habit,
      tag: typeof habit.tag === 'string' ? habit.tag.trim() : ''
    };
  }

  function normalizeState(s) {
  return {
    tasks:       Array.isArray(s.tasks)       ? s.tasks       : [],
    completions: Array.isArray(s.completions) ? s.completions : [],
    players:     Array.isArray(s.players)     ? s.players     : [],
    habits:      Array.isArray(s.habits)      ? s.habits.map(normalizeHabit)      : [],
    flexActions: Array.isArray(s.flexActions) ? s.flexActions : [],
    gameHistory: Array.isArray(s.gameHistory) ? s.gameHistory : [],
    matchups:    Array.isArray(s.matchups)    ? s.matchups    : [],
    schedule:    Array.isArray(s.schedule)    ? s.schedule    : [],
    opponentDripSchedules: Array.isArray(s.opponentDripSchedules) ? s.opponentDripSchedules : [],
    workHistory: Array.isArray(s.workHistory) ? s.workHistory : [],
    youImageId:  typeof s.youImageId === "string" ? s.youImageId : "",
    habitTagColors: normalizeHabitTagColors(s.habitTagColors)
  };
}

function saveMerged(partial) {
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    const existing = raw ? (JSON.parse(raw) || {}) : {};
    const merged = normalizeState({ ...existing, ...partial });
    localStorage.setItem(STORAGE_KEY, JSON.stringify(merged));
    return merged;
  } catch (e) {
    console.error("saveMerged failed", e);
    return partial;
  }
}

function getCompletionPoints(entry) {
  if (window.TaskPointsCore?.pointsForCompletion) {
    return TaskPointsCore.pointsForCompletion(entry);
  }
  return Number(entry?.points) || 0;
}

function syncDerivedPointsIfNeeded() {
  if (!window.TaskPointsCore?.syncDerivedPoints) return;
  const derivedSync = TaskPointsCore.syncDerivedPoints(state);
  state = derivedSync.state;
  if (!derivedSync.changed) return;
  if (window.TaskPointsCore?.mergeAndSaveState) {
    state = TaskPointsCore.mergeAndSaveState(state).state;
  } else {
    state = saveMerged(state);
  }
}

function addDays(d,n){ const x=new Date(d); x.setDate(x.getDate()+n); x.setHours(0,0,0,0); return x; }
function startOfWeek(d){ const x=new Date(d); x.setHours(0,0,0,0); const day=(x.getDay()+6)%7; x.setDate(x.getDate()-day); return x; }
function weekDays(baseDate){
  const start=startOfWeek(baseDate);
  const days=[]; for(let i=0;i<7;i++){ const d=addDays(start,i); days.push({date:d,key:dateKey(d),label:d.toLocaleDateString(undefined,{weekday:'short',month:'short',day:'numeric'})});}
  return days;
}
function dateKey(d){ const y=d.getFullYear(),m=String(d.getMonth()+1).padStart(2,'0'),dd=String(d.getDate()).padStart(2,'0'); return `${y}-${m}-${dd}`; }
function hexToRgb(hex) {
  const normalized = normalizeHexColor(hex);
  if (!normalized) return null;
  const raw = normalized.replace('#', '');
  const r = parseInt(raw.slice(0, 2), 16);
  const g = parseInt(raw.slice(2, 4), 16);
  const b = parseInt(raw.slice(4, 6), 16);
  return { r, g, b };
}

function darkenHex(hex, amount = 0.35) {
  const rgb = hexToRgb(hex);
  if (!rgb) return null;
  const clamp = (value) => Math.max(0, Math.min(255, Math.round(value)));
  const factor = 1 - amount;
  return `#${[
    clamp(rgb.r * factor),
    clamp(rgb.g * factor),
    clamp(rgb.b * factor)
  ].map((val) => val.toString(16).padStart(2, '0')).join('')}`;
}

function getContrastText(hex) {
  const rgb = hexToRgb(hex);
  if (!rgb) return '#f8fafc';
  const toLinear = (c) => {
    const v = c / 255;
    return v <= 0.03928 ? v / 12.92 : Math.pow((v + 0.055) / 1.055, 2.4);
  };
  const luminance = 0.2126 * toLinear(rgb.r) + 0.7152 * toLinear(rgb.g) + 0.0722 * toLinear(rgb.b);
  return luminance > 0.6 ? '#0b0f14' : '#f8fafc';
}

function getHabitTagColor(tag) {
  if (!tag) return null;
  const colors = state.habitTagColors || {};
  return normalizeHexColor(colors[tag]);
}

function getHabitBubbleStyleAttr(tag, status) {
  if (!tag) return '';
  if (status !== 'on' && status !== 'failed') return '';
  const color = getHabitTagColor(tag);
  if (!color) return '';
  const dark = darkenHex(color, 0.35) || color;
  const textColor = getContrastText(color);
  return ` style="background:linear-gradient(135deg, ${color} 0%, ${dark} 100%);border-color:${dark};color:${textColor};"`;
}
function dayDiff(fromKey,toKey){
  if(!fromKey || !toKey) return 0;
  const from = new Date(fromKey + 'T00:00:00');
  const to = new Date(toKey + 'T00:00:00');
  const ms = to - from;
  if (!Number.isFinite(ms) || ms <= 0) return 0;
  return Math.round(ms / 86400000);
}
function trackDueDatePush(task, oldDueISO, newDueISO){
  if(!task) return;
  if (!task.originalDueDateISO && (newDueISO || oldDueISO)) {
    task.originalDueDateISO = newDueISO || oldDueISO || null;
  }
  if(!oldDueISO || !newDueISO) return;
  const delta = dayDiff(oldDueISO, newDueISO);
  if(delta>0){
    const current = Number(task.postponedDays) || 0;
    task.postponedDays = current + delta;
  }
}
function fromKey(k){
  if(!k) return null;
  const parts = String(k).slice(0,10).split("-");
  if(parts.length !== 3) return null;

  const y = parseInt(parts[0], 10);
  const m = parseInt(parts[1], 10);
  const d = parseInt(parts[2], 10);

  if(!Number.isFinite(y) || !Number.isFinite(m) || !Number.isFinite(d)) return null;

  const dt = new Date(y, m - 1, d);
  dt.setHours(0,0,0,0);
  return dt;
}

function niceDate(d){ return d.toLocaleDateString(undefined,{month:'short',day:'numeric'}) }
function todayKey(){ const d=new Date(); d.setHours(0,0,0,0); return dateKey(d); }

function computeNextDueDate(task){
  const rec = task?.recurrence || {};
  const mode = rec.mode || 'none';
  if (mode === 'none') return null;

  const baseKey = task.dueDateISO || todayKey();
  const base = new Date(baseKey + 'T00:00:00');

  let next = null;

  if (mode === 'daily') {
    next = addDays(base, 1);
  } else if (mode === 'everyWeekday') {
    next = addDays(base, 1);
    const d = next.getDay(); // 0 Sun, 6 Sat
    if (d === 6) next = addDays(next, 2);
    else if (d === 0) next = addDays(next, 1);
  } else if (mode === 'weekly') {
    next = addDays(base, 7);
  } else if (mode === 'monthly') {
    next = new Date(base);
    next.setMonth(next.getMonth() + 1);
    next.setHours(0,0,0,0);
  } else if (mode === 'yearly') {
    next = new Date(base);
    next.setFullYear(next.getFullYear() + 1);
    next.setHours(0,0,0,0);
  } else if (mode === 'custom') {
    const count = Number.isFinite(rec.customCount) && rec.customCount > 0 ? rec.customCount : 1;
    const unit  = rec.customUnit || 'day';
    if (unit === 'day') {
      next = addDays(base, count);
    } else if (unit === 'week') {
      next = addDays(base, count * 7);
    } else if (unit === 'month') {
      next = new Date(base);
      next.setMonth(next.getMonth() + count);
      next.setHours(0,0,0,0);
    } else if (unit === 'year') {
      next = new Date(base);
      next.setFullYear(next.getFullYear() + count);
      next.setHours(0,0,0,0);
    }
  }

  return next ? dateKey(next) : null;
}

// Keep weekday labels aligned with scrollable date columns
function syncScrollContainers(a,b){
  if(!a || !b) return;

  const keyA = a.id ? `${a.id}__synced` : null;
  const keyB = b.id ? `${b.id}__synced` : null;

  if(keyA && a.dataset.syncKey === keyA && a.dataset.syncedWith === (b.id||'')) return;

  let lock=false;
  a.addEventListener('scroll',()=>{
    if(lock) return;
    lock=true;
    b.scrollLeft = a.scrollLeft;
    lock=false;
  });
  b.addEventListener('scroll',()=>{
    if(lock) return;
    lock=true;
    a.scrollLeft = b.scrollLeft;
    lock=false;
  });

  if(keyA){ a.dataset.syncKey = keyA; a.dataset.syncedWith = b.id||''; }
  if(keyB){ b.dataset.syncKey = keyB; b.dataset.syncedWith = a.id||''; }
}

/* -------- Habits for arbitrary week -------- */
function renderHabits(baseDate){
  state=load();
  const days=weekDays(baseDate);

  const sections = [
    {
      title: 'habit',
      items: state.habits.filter(h => (h.category||'habit') !== 'vice' && !h.retired),
      labelsId: 'habitWeekLabels',
      listId: 'habitsList',
      emptyId: 'habitsEmpty'
    },
    {
      title: 'vice',
      items: state.habits.filter(h => (h.category||'habit') === 'vice' && !h.retired),
      labelsId: 'vicesWeekLabels',
      listId: 'vicesList',
      emptyId: 'vicesEmpty'
    },
    {
      title: 'retired',
      items: state.habits.filter(h => h.retired),
      labelsId: 'retiredWeekLabels',
      listId: 'retiredList',
      emptyId: 'retiredEmpty'
    }
  ];

  sections.forEach(section => renderHabitSection(section, days, baseDate));

  const start = startOfWeek(baseDate);
  const end = addDays(start,6);
  const label = `${niceDate(start)} – ${niceDate(end)}`;
  ['weekLabel','vicesWeekLabel','retiredWeekLabel'].forEach(id=>{
    const el=$(id);
    if(el) el.textContent = label;
  });
}

function renderHabitSection(section, days, baseDate){
  const labelsWrap=$(section.labelsId); const list=$(section.listId); const empty=$(section.emptyId);
  if(!labelsWrap||!list||!empty) return;

  labelsWrap.innerHTML='';
  list.innerHTML='';

  if(!section.items.length){ empty.style.display='block'; return; }
  empty.style.display='none';

  const labels=document.createElement('div');
  labels.className='habitRow';
  labels.innerHTML=`<div></div>` + days.map(d=>`<div class="text-center text-xs text-zinc-400">${d.label.split(' ')[0]}</div>`).join('');
  labelsWrap.appendChild(labels);

  const sorted = section.items.slice().sort((a,b)=>(b.pointsPerDay||0)-(a.pointsPerDay||0));

  sorted.forEach(h=>{
    h.doneKeys   = Array.isArray(h.doneKeys)?h.doneKeys:[];
    h.failedKeys = Array.isArray(h.failedKeys)?h.failedKeys:[];
    const row = document.createElement('div');
    row.className = 'habitRow';

    const daysHtml = days.map(d=>{
      const on = h.doneKeys.includes(d.key);
      const failed = h.failedKeys.includes(d.key);
      const status = on ? 'on' : (failed ? 'failed' : 'off');
      const className = section.title === 'vice' ? `habitDay viceDay ${status}` : `habitDay ${status}`;
      const styleAttr = getHabitBubbleStyleAttr(h.tag, status);
      return `<div class="${className}"${styleAttr} data-habit="${h.id}" data-day="${d.key}">${d.date.getDate()}</div>`;
    }).join('');

    row.innerHTML = `
      <div class="font-semibold truncate" title="${escapeHtml(h.name)}">
        ${escapeHtml(h.name)}
        <span class="text-xs text-zinc-400">(${h.pointsPerDay||0} pts/day)</span>
        ${h.tag ? `<span class="tag tag-clear ml-2">${escapeHtml(h.tag)}</span>` : ''}
        ${h.retired ? `<span class="ml-2 text-[11px] text-amber-400">(Retired)</span>` : ''}
        <button class="btn btn-ghost text-[11px] ml-2" data-habit-toggle="${h.id}">
          ${h.retired ? 'Unretire' : 'Retire'}
        </button>
      </div>
      ${daysHtml}
    `;

    list.appendChild(row);
  });

  list.querySelectorAll('.habitDay').forEach(el=>{
    el.onclick=()=>toggleHabitDay(el.getAttribute('data-habit'), el.getAttribute('data-day'), baseDate);
  });
  list.querySelectorAll('[data-habit-toggle]').forEach(btn=>{
    btn.onclick = () => toggleHabitRetired(btn.getAttribute('data-habit-toggle'), baseDate);
  });

  syncScrollContainers(labelsWrap, list);
}
function toggleHabitDay(habitId, dayKey, baseDate){
  state = load();
  const h = state.habits.find(x=>x.id===habitId);
  if (!h || h.retired) return;  // ⬅️ NEW: don’t toggle retired habits

  h.doneKeys   = Array.isArray(h.doneKeys) ? h.doneKeys : [];
  h.failedKeys = Array.isArray(h.failedKeys) ? h.failedKeys : [];

  const category = (h.category || 'habit');
  const source   = category === 'vice' ? 'vice' : 'habit';

  const removeCompletionForDay = () => {
    const mIdx = state.completions.findIndex(c =>
      (c.source === 'habit' || c.source === 'vice') &&
      c.habitId === habitId &&
      c.dayKey === dayKey
    );
    if (mIdx !== -1) state.completions.splice(mIdx, 1);
  };

  if (category === 'vice') {
    const doneIdx   = h.doneKeys.indexOf(dayKey);
    const failedIdx = h.failedKeys.indexOf(dayKey);

    if (doneIdx === -1 && failedIdx === -1) {
      h.doneKeys.push(dayKey);
      const iso = new Date(fromKey(dayKey).getTime() + 12*3600*1000).toISOString();
      state.completions.unshift({
        id: crypto.randomUUID(),
        taskId: `habit:${habitId}:${dayKey}`,
        title: `[Habit] ${h.name} (${dayKey})`,
        points: h.pointsPerDay || 0,
        completedAtISO: iso,
        source,
        habitId: habitId,
        dayKey: dayKey
      });
    } else if (doneIdx !== -1) {
      h.doneKeys.splice(doneIdx,1);
      removeCompletionForDay();
      if (failedIdx === -1) h.failedKeys.push(dayKey);
    } else {
      h.failedKeys.splice(failedIdx,1);
      removeCompletionForDay();
    }
  } else {
    const idx = h.doneKeys.indexOf(dayKey);
    if (idx === -1) {
      h.doneKeys.push(dayKey);
      const iso = new Date(fromKey(dayKey).getTime() + 12*3600*1000).toISOString();
      state.completions.unshift({
        id: crypto.randomUUID(),
        taskId: `habit:${habitId}:${dayKey}`,
        title: `[Habit] ${h.name} (${dayKey})`,
        points: h.pointsPerDay || 0,
        completedAtISO: iso,
        source,
        habitId: habitId,
        dayKey: dayKey
      });
    } else {
      h.doneKeys.splice(idx,1);
      removeCompletionForDay();
    }

    const failedIdx = h.failedKeys.indexOf(dayKey);
    if (failedIdx !== -1) h.failedKeys.splice(failedIdx,1);
  }

  state = saveMerged(state);
  renderHabits(baseDate);
}
function toggleHabitRetired(habitId, baseDate){
  state = load();
  const h = state.habits.find(x=>x.id === habitId);
  if (!h) return;

  h.retired = !h.retired;
  state = saveMerged(state);
  renderHabits(baseDate);
}

/* -------- Tasks for arbitrary week -------- */
function renderWeekTasks(baseDate){
  state=load();
  const days=weekDays(baseDate);
  const grid=$('weekGrid'); grid.innerHTML='';
  const todayK = todayKey();
  days.forEach(d=>{
    const col=document.createElement('div'); col.className='slot';
    col.innerHTML=`<div class="text-xs text-zinc-400 mb-2 font-semibold">${d.label}</div>`;
    const list = state.tasks.filter(t=>!t.completedAtISO && t.dueDateISO===d.key);
    list.forEach(t=>{
      const overdue = t.dueDateISO && t.dueDateISO < todayK;
      const postponeDays = Number(t.postponedDays) || 0;
      const showPostponePill = postponeDays > 0 && !!t.dueDateISO;
      const importance = t.importance || 'Medium';
      const taskClasses = ['task'];
      if (importance === 'Critical') taskClasses.push('critical-card');
      else if (importance === 'High') taskClasses.push('high-card');

      const importanceClass = ({
        Low:      'tag bg-transparent text-zinc-500 border border-zinc-700',
        Medium:   'tag bg-teal-400/40 text-teal-950',
        High:     'tag tag-high',
        Critical: 'tag tag-critical'
      }[importance]) || 'tag bg-teal-400/40 text-teal-950';
      const importanceBadge = `<span class="${importanceClass}">${importance}</span>`;

      const tags = Array.isArray(t.tags) ? t.tags : [];
      const tagsHtml = tags.length ? tags.map(tag => `<span class="tag bg-zinc-700/40">${escapeHtml(tag)}</span>`).join('') : '';
      const pointsLabel = Number.isFinite(Number(t.points)) ? `<span class="tag bg-teal-500/20 text-teal-100 border border-teal-500/40">${Number(t.points)} pts</span>` : '';

      const div=document.createElement('div');
      div.className=taskClasses.join(' ');
      div.innerHTML=`
        <div class="flex flex-col gap-2">
          <div class="flex items-start justify-between gap-3">
            <div class="text-sm leading-snug break-words font-semibold">${escapeHtml(t.title)}</div>
            <div class="flex items-center gap-2 flex-shrink-0">${importanceBadge}</div>
          </div>
          <div class="flex items-center gap-2 flex-wrap text-[11px] text-zinc-200">
            ${showPostponePill ? `<span class="tag postpone-pill">+${postponeDays}d</span>` : ''}
            ${overdue ? `<span class="tag bg-amber-500/20 text-amber-100 border border-amber-500/40">Overdue</span>` : ''}
            ${pointsLabel}
            ${tagsHtml}
          </div>
          <div class="flex gap-1 flex-wrap mt-1">
            ${overdue?`<button class="btn btn-warn" onclick="postponeTask('${t.id}')">Postpone</button>`:''}
            <button class="btn btn-ghost" onclick="addOneDay('${t.id}')">+1 day</button>
            <button class="btn btn-teal" onclick="completeTask('${t.id}')" title="Done">✓</button>
          </div>
        </div>`;
      col.appendChild(div);
    });
    grid.appendChild(col);
  });
}
function postponeTask(id){
  let st=load(); const t=st.tasks.find(x=>x.id===id); if(!t || !t.dueDateISO) return;
  const oldDue = t.dueDateISO;
  t.dueDateISO = todayKey();
  trackDueDatePush(t, oldDue, t.dueDateISO);
  st = saveMerged(st);

  state=st; renderAll(currentBaseDate);
}
function wontDo(id, dayKey){
  let st=load(); const t=st.tasks.find(x=>x.id===id); if(!t) return;
  const mode=(t.recurrence && t.recurrence.mode)||'none';
  if(mode==='none'){
    if(!confirm('Won’t do this task? It will be removed.')) return;
    st.tasks = st.tasks.filter(x=>x.id!==id);
  }else{
    t.skipDates = Array.isArray(t.skipDates)?t.skipDates:[];
    if(!t.skipDates.includes(dayKey)) t.skipDates.push(dayKey);
    if(t.dueDateISO===dayKey) t.dueDateISO = todayKey();
  }
  st = saveMerged(st);
state = st;
renderAll(currentBaseDate);

}

function addOneDay(id){
  let st = load();
  const t = st.tasks.find(x => x.id === id);
  if(!t) return;

  const oldDue = t.dueDateISO || todayKey();
  const oldDate = fromKey(oldDue) || fromKey(todayKey()) || new Date();
  const newDate = addDays(oldDate, 1);

  t.dueDateISO = dateKey(newDate);
  trackDueDatePush(t, oldDue, t.dueDateISO);

  st = saveMerged(st);
  state = st;
  renderAll(currentBaseDate);
}


function completeTask(id){
  let st = load();
  const t = st.tasks.find(x => x.id === id);
  if(!t) return;

  const nowISO = new Date().toISOString();
  const dk = todayKey();

  const rec = t.recurrence || {};
  const mode = rec.mode || 'none';

  if (mode === 'none') {
    t.completedAtISO = nowISO;
  } else {
    const nextKey = computeNextDueDate(t);
    if (nextKey) t.dueDateISO = nextKey;
    t.completedAtISO = null;
  }

  st.completions = Array.isArray(st.completions) ? st.completions : [];
  st.completions.unshift({
    id: (window.crypto && typeof crypto.randomUUID === "function")
      ? crypto.randomUUID()
      : ("id_" + Date.now().toString(36) + "_" + Math.random().toString(36).slice(2)),
    taskId: id,
    title: t.title,
    points: Number(t.points || 0),
    dateKey: dk,
    completedAtISO: nowISO
  });

  st = saveMerged(st);
  state = st;
  renderAll(currentBaseDate);
}


function renderFlexWeek(baseDate){
  state = load();
  const list = $('flexWeekList');
  const empty = $('flexWeekEmpty');
  if(!list || !empty) return;
  list.innerHTML = '';

  const all = Array.isArray(state.completions) ? state.completions : [];
  if(!all.length){
    empty.style.display = 'block';
    return;
  }

  const days = weekDays(baseDate);
  const keys = new Set(days.map(d=>d.key));

  const flexEntries = all.filter(c=>{
    if(c.source !== 'flex' || !c.completedAtISO) return false;
    const d = new Date(c.completedAtISO);
    const dk = dateKey(d);
    return keys.has(dk);
  });

  if(!flexEntries.length){
    empty.style.display = 'block';
    return;
  }
  empty.style.display = 'none';

  flexEntries
    .slice()
    .sort((a,b)=> new Date(b.completedAtISO) - new Date(a.completedAtISO))
    .forEach(c=>{
      const div = document.createElement('div');
      div.className = 'flex items-center justify-between';
      const when = new Date(c.completedAtISO);
      div.innerHTML = `
        <div>
          <div class="font-medium">${escapeHtml(c.title||'Flex action')}</div>
          <div class="text-xs text-zinc-400">${when.toLocaleString()}</div>
        </div>
        <div class="font-semibold">+${getCompletionPoints(c).toLocaleString()} pts</div>
      `;
      list.appendChild(div);
    });
}

function renderRetiredFlexActions(){
  state = load();
  const list = $('retiredFlexList');
  const empty = $('retiredFlexEmpty');
  if(!list || !empty) return;
  list.innerHTML = '';

  const items = (Array.isArray(state.flexActions) ? state.flexActions : []).filter(f => f.retired);
  if(!items.length){
    empty.style.display = 'block';
    return;
  }
  empty.style.display = 'none';

  items
    .slice()
    .sort((a, b) => (a.name || '').localeCompare(b.name || ''))
    .forEach(f => {
      const div = document.createElement('div');
      div.className = 'flex items-center justify-between';
      div.innerHTML = `
        <div>
          <div class="font-medium">${escapeHtml(f.name || 'Flex action')}</div>
          <div class="text-xs text-zinc-400">${Number(f.points || 0)} pts/use</div>
        </div>
        <div class="flex gap-2 flex-wrap">
          <button class="btn btn-ghost btn-task" data-flex-toggle="${f.id}">Unretire</button>
        </div>
      `;
      list.appendChild(div);
    });

  list.querySelectorAll('[data-flex-toggle]').forEach(btn => {
    btn.onclick = () => toggleFlexRetired(btn.getAttribute('data-flex-toggle'));
  });
}

function toggleFlexRetired(id){
  state = load();
  const f = Array.isArray(state.flexActions) ? state.flexActions.find(x => x.id === id) : null;
  if(!f) return;
  f.retired = !f.retired;
  state = saveMerged(state);
  renderRetiredFlexActions();
}

function renderWeekScoreSection(baseDate, config) {
  state = load();

  const list  = $(config.listId);
  const empty = $(config.emptyId);
  if (!list || !empty) return;

  list.innerHTML = '';

  const days = weekDays(baseDate);
  const keys = new Set(days.map(d => d.key));

  const completionEntries = (Array.isArray(state.completions) ? state.completions : []).filter(c => {
    if (!c || !c.title || !c.completedAtISO) return false;
    if (typeof config.match !== 'function' || !config.match(c)) return false;

    const d  = new Date(c.completedAtISO);
    if (isNaN(d)) return false;
    const dk = dateKey(d);
    return keys.has(dk);
  });

  const fallbackEntries = typeof config.buildFallback === 'function'
    ? config.buildFallback(state, keys)
    : [];

  const combined = [...completionEntries, ...fallbackEntries];

  if (!combined.length) {
    empty.style.display = 'block';
    return;
  }

  empty.style.display = 'none';

  combined
    .slice()
    .sort((a, b) => {
      const ta = a.completedAtISO ? new Date(a.completedAtISO).getTime() : 0;
      const tb = b.completedAtISO ? new Date(b.completedAtISO).getTime() : 0;
      return tb - ta;
    })
    .forEach(c => {
      const when = c.completedAtISO ? new Date(c.completedAtISO) : null;
      const whenLabel = (when && !isNaN(when)) ? when.toLocaleString() : '';

      const div = document.createElement('div');
      div.className = 'flex items-center justify-between';

      div.innerHTML = `
        <div>
          <div class="font-medium">${escapeHtml(c.title || config.defaultTitle || '')}</div>
          <div class="text-xs text-zinc-400">${whenLabel}</div>
        </div>
        <div class="font-semibold">+${getCompletionPoints(c).toLocaleString()} pts</div>
      `;

      list.appendChild(div);
    });
}

function renderWorkWeek(baseDate) {
  renderWeekScoreSection(baseDate, {
    listId: 'workWeekList',
    emptyId: 'workWeekEmpty',
    defaultTitle: 'Work Score',
    match: c => typeof c?.title === 'string' && c.title.startsWith('Work Score'),
    buildFallback: (state, keys) => {
      const hist = Array.isArray(state.workHistory) ? state.workHistory : [];
      return hist.filter(h => {
        if (!h) return false;
        let dk = null;
        if (h.dateKey) {
          dk = h.dateKey;
        } else if (h.dayKey) {
          dk = h.dayKey;
        } else if (h.date) {
          const d = new Date(h.date);
          if (!isNaN(d)) dk = dateKey(d);
        } else if (h.completedAtISO) {
          const d = new Date(h.completedAtISO);
          if (!isNaN(d)) dk = dateKey(d);
        }
        if (!dk) return false;
        return keys.has(dk);
      }).map(h => ({
        title: h.title || 'Work Score',
        points: h.points ?? h.score ?? h.value ?? h.workScore ?? 0,
        completedAtISO: h.completedAtISO || h.date || null
      }));
    }
  });
}

function renderSleepWeek(baseDate) {
  renderWeekScoreSection(baseDate, {
    listId: 'sleepWeekList',
    emptyId: 'sleepWeekEmpty',
    defaultTitle: 'Sleep Score',
    match: c => typeof c?.title === 'string' && c.title.startsWith('Sleep Score')
  });
}

function renderCaloriesWeek(baseDate) {
  renderWeekScoreSection(baseDate, {
    listId: 'caloriesWeekList',
    emptyId: 'caloriesWeekEmpty',
    defaultTitle: 'Calories',
    match: c => typeof c?.title === 'string' && c.title.startsWith('Calories (')
  });
}

function renderMoodWeek(baseDate) {
  renderWeekScoreSection(baseDate, {
    listId: 'moodWeekList',
    emptyId: 'moodWeekEmpty',
    defaultTitle: 'Mood Score',
    match: c => typeof c?.title === 'string' && c.title.startsWith('Mood Score')
  });
}

function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m])); }

function syncCustomRepeatUI(repeatSelectEl) {
  const row = document.getElementById('repeatCustomRow');
  if (!row || !repeatSelectEl) return;

  if (repeatSelectEl.value === 'custom') row.classList.remove('hidden');
  else row.classList.add('hidden');
}

function openAddTaskModal() {
  const modal = $("addTaskModal");
  if (!modal) return;

  modal.classList.remove("hidden");
  modal.classList.add("flex");
  $("titleInput")?.focus();

  const rep = $("repeatInput");
  syncCustomRepeatUI(rep);
}

function closeAddTaskModal() {
  const modal = $("addTaskModal");
  if (!modal) return;

  modal.classList.add("hidden");
  modal.classList.remove("flex");
}

function setDueToday(){
  $('dueDateInput').value = todayKey();
}

function clearAddTaskForm(){
  $('titleInput').value='';
  $('pointsInput').value='';
  $('dueDateInput').value='';
  $('importanceInput').value='Medium';
  $('repeatInput').value='none';
  if ($('repeatCustomCount')) $('repeatCustomCount').value='1';
  if ($('repeatCustomUnit')) $('repeatCustomUnit').value='day';
  if ($('tagsInput')) $('tagsInput').value='';
  const repeatCustomRow = $('repeatCustomRow');
  if (repeatCustomRow) repeatCustomRow.classList.add('hidden');
}

function addTask(){
  const title = $('titleInput').value.trim();
  if(!title) return alert('Enter a task name');

  const mode = $('repeatInput').value || 'none';
  const rec = { mode };

  const rawTags = ($('tagsInput')?.value || '');
  const tags = rawTags
    .split(',')
    .map(s => s.trim())
    .filter(s => s.length > 0);

  if (mode === 'custom') {
    const countRaw = $('repeatCustomCount')?.value;
    const unitRaw  = $('repeatCustomUnit')?.value;
    let count = parseInt(countRaw, 10);
    if (!Number.isFinite(count) || count <= 0) count = 1;
    const unit = (unitRaw === 'week' || unitRaw === 'month' || unitRaw === 'year') ? unitRaw : 'day';
    rec.customCount = count;
    rec.customUnit = unit;
  }

  const dueDate = $('dueDateInput').value || null;
  const task = {
    id: crypto.randomUUID(),
    title,
    importance: $('importanceInput').value,
    dueDateISO: dueDate,
    originalDueDateISO: dueDate,
    points: Number($('pointsInput').value)||0,
    recurrence: rec,
    tags,
    skipDates: [],
    hidden: false,
    completedAtISO: null,
    createdAtISO: new Date().toISOString(),
    postponedDays: 0
  };

  const st = load();
  st.tasks.unshift(task);
  state = saveMerged(st);
  clearAddTaskForm();
  renderAll(currentBaseDate);
  closeAddTaskModal();
}

/* Nav buttons */
function renderAll(date) {
  renderHabits(date);
  renderWeekTasks(date);
  renderFlexWeek(date);
  renderRetiredFlexActions();
  renderWorkWeek(date);
  renderSleepWeek(date);
  renderCaloriesWeek(date);
  renderMoodWeek(date);
}

function handleWeekNav(action) {
  if (action === 'prev') {
    currentBaseDate = addDays(startOfWeek(currentBaseDate), -7);
  } else if (action === 'next') {
    currentBaseDate = addDays(startOfWeek(currentBaseDate), 7);
  } else if (action === 'this') {
    currentBaseDate = new Date();
  }

  renderAll(currentBaseDate);
}

document.querySelectorAll('[data-week-nav]').forEach(btn => {
  btn.addEventListener('click', () => handleWeekNav(btn.dataset.weekNav));
});

document.addEventListener('DOMContentLoaded', () => {
  $('openAddTaskBtn')?.addEventListener('click', openAddTaskModal);
  $('addBtn')?.addEventListener('click', addTask);

  const rep = $("repeatInput");
  rep?.addEventListener("change", () => syncCustomRepeatUI(rep));
  rep?.addEventListener("input",  () => syncCustomRepeatUI(rep));
  syncCustomRepeatUI(rep);
});

renderAll(currentBaseDate);

</script>

<!-- ADD TASK MODAL -->
<div
  id="addTaskModal"
  class="fixed inset-0 z-40 hidden items-center justify-center bg-black/60"
>
  <div class="addTaskModalPanel w-full max-w-xl mx-4 rounded-2xl px-6 pb-6 pt-12 relative bg-zinc-900 text-zinc-100">
    <button
      type="button"
      class="absolute top-4 right-4 btn btn-secondary text-xs px-3 py-1 rounded-md"
      onclick="closeAddTaskModal()"
    >
      Close
    </button>

    <div id="addTaskModalBody" class="grid gap-3">
      <input id="titleInput" class="input" placeholder="e.g., 30-min treadmill walk">

      <div id="addTaskRow2" class="flex flex-wrap gap-2 mt-1">
        <select id="importanceInput" class="input flex-1 min-w-[120px]">
          <option>Low</option>
          <option selected>Medium</option>
          <option>High</option>
          <option>Critical</option>
        </select>

        <input id="dueDateInput" type="date" class="input flex-1 min-w-[120px]">

        <button class="addTaskTodayBtn btn btn-ghost text-xs px-2" onclick="setDueToday()">Today</button>
      </div>

      <div id="addTaskRow3" class="flex flex-wrap gap-2 mt-1">
        <input id="pointsInput" type="number" min="0" class="input w-24" placeholder="e.g., 25">

        <select id="repeatInput" class="input flex-1 min-w-[120px]">
          <option value="none">Does not repeat</option>
          <option value="daily">Every day</option>
          <option value="weekdays">Weekdays (Mon–Fri)</option>
          <option value="weekly">Every week</option>
          <option value="monthly">Every month (same date)</option>
          <option value="yearly">Every year (same date)</option>
          <option value="custom">Custom…</option>
        </select>
      </div>

      <div id="repeatCustomRow" class="flex items-center gap-2 text-xs mt-2 hidden">
        <span class="muted">Repeat every</span>
        <input id="repeatCustomCount" type="number" min="1" class="input w-16" value="1">
        <select id="repeatCustomUnit" class="input w-24">
          <option value="day">day(s)</option>
          <option value="week">week(s)</option>
          <option value="month">month(s)</option>
          <option value="year">year(s)</option>
        </select>
      </div>

      <input
        id="tagsInput"
        class="input"
        placeholder="Tags (e.g., work, coding, creative)"
      >

      <button id="addBtn" class="btn btn-primary">Add Task</button>
    </div>
  </div>
</div>

<button
  class="hidden md:hidden fixed top-3 right-3 z-40 btn btn-teal rounded-full shadow-lg px-4 py-2 text-sm flex items-center gap-1"
  type="button"
  data-scroll-top
>
  <span>⬆️</span>
  <span>Top</span>
</button>
</body>
</html>




