<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>TaskPoints — Matchups Log</title>

  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <meta name="apple-mobile-web-app-title" content="TaskPoints" />

  <!-- TP icon -->
  <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'><rect width='512' height='512' rx='120' fill='black'/><text x='50%' y='55%' dominant-baseline='middle' text-anchor='middle' font-size='150' fill='white'>TP</text></svg>">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 128 128'><rect width='128' height='128' rx='30' fill='black'/><text x='50%' y='55%' dominant-baseline='middle' text-anchor='middle' font-size='60' fill='white'>TP</text></svg>">

  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="styles.css">
  <script src="toolbar.js" defer></script>

  <style>
    /* Match game.html body style so everything feels unified  */
    body{
      background:#fafafa;
      color:#111827;
    }
    @media (prefers-color-scheme: dark) {
      body{
        background:#0a0a0a;
        color:#fafafa;
      }
    }

    /* Heading for each day group */
    .matchup-day {
      font-size: 1rem;
      font-weight: 600;
      margin-bottom: 0.35rem;
    }

    /* Individual matchup line, inside a glass-style section */
    .matchup-item {
      background: rgba(15,23,42,0.35);
      padding: 0.45rem 0.7rem;
      border-radius: 0.75rem;
      border: 1px solid rgba(15,23,42,0.7);
      font-size: 0.9rem;
    }

    /* Highlight rows that involve YOU using a teal-ish accent */
    .matchup-item.you {
      background: rgba(34,197,94,0.15);
      border-color: rgba(34,197,94,0.55);
    }
  </style>
</head>
<body class="min-h-screen">
  <div class="mx-auto max-w-6xl p-4 sm:p-6">

    <!-- Header / nav: same structure + teal buttons as game.html  -->
    <header class="flex flex-wrap items-center justify-between gap-3 mb-4">
      <a href="index.html" class="flex items-center gap-3">
        <div class="w-9 h-9 rounded-2xl grid place-items-center bg-black text-white font-bold">TP</div>
        <div>
          <h1 class="text-2xl sm:text-3xl font-extrabold tracking-tight">TaskPoints</h1>
          <p class="text-xs opacity-70">Game — Matchups Log</p>
        </div>
      </a>
      <div class="toolbar header-nav">
        <a href="index.html"         class="btn btn-teal btn-toolbar nav-btn">Main</a>
        <a href="daily.html"         class="btn btn-teal btn-toolbar nav-btn">Daily</a>
        <a href="daily_sources.html" class="btn btn-teal btn-toolbar nav-btn">Sources</a>
        <a href="log.html"           class="btn btn-teal btn-toolbar nav-btn">Log</a>
        <a href="week.html"          class="btn btn-teal btn-toolbar nav-btn">Week</a>
        <div class="dropdown">
          <button type="button" class="btn btn-teal btn-toolbar nav-btn dropdown-toggle active" data-dropdown-toggle aria-expanded="false">Game <span class="caret">▾</span></button>
          <div class="dropdown-menu">
            <a href="game.html"         class="btn btn-teal btn-toolbar nav-btn">Game</a>
            <a href="standings.html"    class="btn btn-teal btn-toolbar nav-btn">Standings</a>
            <a href="matchups.html"     class="btn btn-teal btn-toolbar nav-btn active" aria-current="page">Matchups</a>
            <a href="schedule.html"     class="btn btn-teal btn-toolbar nav-btn">Schedule</a>
            <a href="game_ratings.html" class="btn btn-teal btn-toolbar nav-btn">Ratings</a>
          </div>
        </div>
        <a href="projects.html" class="btn btn-teal btn-toolbar nav-btn">Projects</a>
        <a href="settings.html" class="btn btn-teal btn-toolbar nav-btn">Settings</a>
      </div>
    </header>

    <!-- Top explainer panel: reuse your glass panel look from main/index  -->
    <section class="glass mb-4">
      <h2 class="font-semibold text-lg mb-1">Matchups Log</h2>
      <p class="text-sm muted">
        Every simulated head-to-head result, grouped by day. You are listed as <strong>You</strong>.
      </p>
    </section>

    <!-- Where we render daily matchup groups -->
    <section id="matchupsContainer" class="space-y-4"></section>
  </div>

  <script>
    const STORAGE_KEY = "taskpoints_v1";
    const $ = (id) => document.getElementById(id);

function load() {
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (!raw) {
      return { tasks:[], completions:[], players:[], habits:[], flexActions:[], gameHistory:[], matchups:[], schedule:[], opponentDripSchedules: [] };
    }

    const p = JSON.parse(raw) || {};

    return {
      tasks:       Array.isArray(p.tasks)       ? p.tasks       : [],
      completions: Array.isArray(p.completions) ? p.completions : [],
      players:     Array.isArray(p.players)     ? p.players     : [],
      habits:      Array.isArray(p.habits)      ? p.habits      : [],
      flexActions: Array.isArray(p.flexActions) ? p.flexActions : [],
      gameHistory: Array.isArray(p.gameHistory) ? p.gameHistory : [],
      matchups:    Array.isArray(p.matchups)    ? p.matchups    : [],
      schedule:    Array.isArray(p.schedule)    ? p.schedule    : [],
      opponentDripSchedules: Array.isArray(p.opponentDripSchedules) ? p.opponentDripSchedules : []
    };

  } catch (e) {
    console.error("Failed to load TaskPoints state", e);
    return { tasks:[], completions:[], players:[], habits:[], flexActions:[], gameHistory:[], matchups:[], schedule:[], opponentDripSchedules: [] };
  }
}

    // Turn a Date (or ISO string) into "YYYY-MM-DD" like the rest of the app
    function dateKey(d) {
      const dt = d instanceof Date ? d : new Date(d);
      if (!dt || Number.isNaN(dt.getTime())) return "";
      const y = dt.getFullYear();
      const m = String(dt.getMonth() + 1).padStart(2, "0");
      const day = String(dt.getDate()).padStart(2, "0");
      return `${y}-${m}-${day}`;
    }

    // Build a map of { dateKey -> your true total points } from completions
    function computeYouDailyTotals(completions) {
      const totals = {};
      if (!Array.isArray(completions)) return totals;

      for (const c of completions) {
        if (!c) continue;

        // prefer stored dateKey, fall back to completedAtISO
        let key = c.dateKey;
        if (!key && c.completedAtISO) {
          key = dateKey(c.completedAtISO);
        }
        if (!key) continue;

        const pts = Number(c.points || 0);
        if (!Number.isFinite(pts)) continue;

        totals[key] = (totals[key] || 0) + pts;
      }

      return totals;
    }

    // OPTION A: only fix *your* side of each matchup to match the new daily totals
    function syncYouMatchupsWithCompletions(state) {
      const dailyTotals = computeYouDailyTotals(state.completions || []);
      if (!Object.keys(dailyTotals).length) return;

      const list = state.matchups || [];
      let changed = false;

      for (let i = 0; i < list.length; i++) {
        const m = list[i];
        if (!m) continue;

        const key = m.dateKey || m.date || (m.dateISO ? dateKey(m.dateISO) : "");
        if (!key) continue;

        const youScoreForDay = dailyTotals[key];
        if (youScoreForDay == null) continue;

        const aIsYou = m.playerAId === "YOU";
        const bIsYou = m.playerBId === "YOU";
        if (!aIsYou && !bIsYou) continue; // AI vs AI stays untouched

        let scoreA = Number(m.scoreA);
        let scoreB = Number(m.scoreB);

        // if already in sync, skip
        if (aIsYou && scoreA === youScoreForDay) continue;
        if (bIsYou && scoreB === youScoreForDay) continue;

        if (aIsYou) scoreA = youScoreForDay;
        if (bIsYou) scoreB = youScoreForDay;

        const diff = scoreA - scoreB;

        // Re-derive result label, still Option A: opponent scores unchanged
        let result;
        if (aIsYou || bIsYou) {
          const ys = aIsYou ? scoreA : scoreB;
          const os = aIsYou ? scoreB : scoreA;

          if (ys > os) result = "you-win";
          else if (ys < os) result = "you-loss";
          else result = "tie";
        } else {
          // (safe fallback, though we never hit this with aIsYou/bIsYou check)
          if (scoreA > scoreB) result = "a-win";
          else if (scoreA < scoreB) result = "b-win";
          else result = "tie";
        }

        list[i] = {
          ...m,
          scoreA,
          scoreB,
          diff,
          result,
          dateKey: key
        };
        changed = true;
      }

if (changed) {
  save(state);
}


} // <-- closes syncYouMatchupsWithCompletions


    function ordinal(n){
      const s=["th","st","nd","rd"], v=n%100;
      return n + (s[(v-20)%10] || s[v] || s[0]);
    }

    function formatLongDate(key){
      // key: "YYYY-MM-DD"
      const [y,m,d] = key.split("-").map(x => parseInt(x,10));
      const dt = new Date(y, m-1, d);
      const weekday = dt.toLocaleDateString(undefined, { weekday:"long" });
      const month   = dt.toLocaleDateString(undefined, { month:"short" });
      return `${weekday}, ${month} ${ordinal(d)}, ${y}`;
    }

    function renderMatchups(){
      const state = load();

// sync may write back; keep local state updated
syncYouMatchupsWithCompletions(state);


      const container = $("matchupsContainer");
      container.innerHTML = "";

      const matchups = Array.isArray(state.matchups) ? state.matchups.slice() : [];
      if (!matchups.length) {
        const empty = document.createElement("section");
        empty.className = "glass";
        empty.innerHTML = "<div class='text-sm muted'>No matchups have been simulated yet.</div>";
        container.appendChild(empty);
        return;
      }

      // Map player IDs to names (You is special)
      const nameById = {};
      (state.players || []).forEach(p => {
        if (!p || !p.id) return;
        nameById[p.id] = p.name || "Unnamed";
      });

      function getName(id){
        if (id === "YOU") return "You";
        return nameById[id] || "Unknown";
      }

      function describeMatchup(m){
        const aId = m.playerAId;
        const bId = m.playerBId;
        const aScore = Number(m.scoreA);
        const bScore = Number(m.scoreB);
        const aName = getName(aId);
        const bName = getName(bId);

        const aIsYou = aId === "YOU";
        const bIsYou = bId === "YOU";

        if (aIsYou || bIsYou) {
          const youScore = aIsYou ? aScore : bScore;
          const oppScore = aIsYou ? bScore : aScore;
          const oppName  = aIsYou ? bName  : aName;

          if (youScore > oppScore) {
            return `You beat ${oppName}, ${youScore}–${oppScore}`;
          } else if (youScore < oppScore) {
            return `You lost to ${oppName}, ${youScore}–${oppScore}`;
          } else {
            return `You tied ${oppName}, ${youScore}–${oppScore}`;
          }
        }

        if (aScore > bScore) {
          return `${aName} beat ${bName}, ${aScore}–${bScore}`;
        } else if (bScore > aScore) {
          return `${bName} beat ${aName}, ${bScore}–${aScore}`;
        } else {
          return `${aName} and ${bName} tied, ${aScore}–${bScore}`;
        }
      }

      // Group by date key
      const groups = new Map();
      matchups.forEach(m => {
        const key = m.dateKey || m.date || (m.dateISO ? dateKey(m.dateISO) : "");
        if (!groups.has(key)) groups.set(key, []);
        groups.get(key).push(m);
      });

      // Sort dates descending
      const dateKeys = Array.from(groups.keys()).sort((a,b) => b.localeCompare(a));

      dateKeys.forEach(key => {
        const section = document.createElement("section");
        section.className = "glass mb-4";

        const heading = document.createElement("h2");
        heading.className = "matchup-day";
        heading.textContent = formatLongDate(key);
        section.appendChild(heading);

        const list = document.createElement("ul");
        list.className = "space-y-1";

        groups.get(key)
          .slice()
          .sort((a,b) => (a.id || "").localeCompare(b.id || ""))
          .forEach(m => {
            const li = document.createElement("li");
            li.className = "matchup-item";
            if (m.playerAId === "YOU" || m.playerBId === "YOU") {
              li.classList.add("you");
            }
            li.textContent = describeMatchup(m);
            list.appendChild(li);
          });

        section.appendChild(list);
        container.appendChild(section);
      });
    }

function normalizeState(s) {
  return {
    tasks:       Array.isArray(s.tasks)       ? s.tasks       : [],
    completions: Array.isArray(s.completions) ? s.completions : [],
    players:     Array.isArray(s.players)     ? s.players     : [],
    habits:      Array.isArray(s.habits)      ? s.habits      : [],
    flexActions: Array.isArray(s.flexActions) ? s.flexActions : [],
    gameHistory: Array.isArray(s.gameHistory) ? s.gameHistory : [],
    matchups:    Array.isArray(s.matchups)    ? s.matchups    : [],
    schedule:    Array.isArray(s.schedule)    ? s.schedule    : [],
    opponentDripSchedules: Array.isArray(s.opponentDripSchedules) ? s.opponentDripSchedules : []
  };
}

function save(nextState) {
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    const existing = raw ? (JSON.parse(raw) || {}) : {};
    const merged = normalizeState({ ...existing, ...nextState });
    localStorage.setItem(STORAGE_KEY, JSON.stringify(merged));
    return merged;
  } catch (e) {
    console.error("Failed to save TaskPoints state", e);
    return nextState;
  }
}


      
    document.addEventListener("DOMContentLoaded", renderMatchups);
  </script>
</body>
</html>


