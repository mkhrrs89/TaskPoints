<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>TaskPoints — Player Ratings</title>

  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <meta name="apple-mobile-web-app-title" content="TaskPoints" />

  <!-- Simple TP icon (same as other pages) -->
  <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' width='256' height='256'><rect width='256' height='256' fill='%230b0d10'/><text x='128' y='160' text-anchor='middle' font-size='150' fill='white'>TP</text></svg>">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><circle cx='50' cy='50' r='48' fill='%230b0d10'/><text x='50' y='62' font-size='60' text-anchor='middle' fill='white'>TP</text></svg>">

  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="styles.css">
  <script src="toolbar.js" defer></script>
  <script src="scoring_core.js"></script>

  <style>
    body{
      background:#fafafa;
      color:#111827;
    }
    @media (prefers-color-scheme: dark) {
      body{
        background:#0a0a0a;
        color:#fafafa;
      }
    }

    .card{
      border:1px solid rgb(228 228 231);
      background:rgba(255,255,255,0.85);
      border-radius:16px;
      padding:16px;
      box-shadow:0 10px 30px rgba(0,0,0,0.12);
      backdrop-filter:blur(10px);
    }
    @media (prefers-color-scheme: dark) {
      .card{
        border-color:rgb(39 39 42);
        background:rgba(24,24,27,0.9);
      }
    }

    table{
      width:100%;
      border-collapse:collapse;
      font-size:13px;
    }
    thead{
      border-bottom:1px solid rgba(148,163,184,0.4);
    }
    th, td{
      padding:6px 8px;
      text-align:left;
      white-space:nowrap;
    }
    th{
      font-size:12px;
      text-transform:uppercase;
      letter-spacing:0.06em;
      opacity:0.75;
      cursor:pointer;
      user-select:none;
    }
    tr:nth-child(every){
      background:transparent;
    }
    tbody tr:nth-child(2n){
      background:rgba(148,163,184,0.05);
    }
    @media (prefers-color-scheme: dark){
      tbody tr:nth-child(2n){
        background:rgba(3,32,32,0.9);
      }
    }

    .sort-indicator{
      font-size:10px;
      opacity:0.8;
      margin-left:4px;
    }
  </style>
</head>
<body class="min-h-screen">
  <div class="mx-auto max-w-6xl p-4 sm:p-6">
    <div class="flex items-center justify-between gap-3 mb-3 md:hidden">
      <a href="index.html" class="flex items-center gap-3">
        <img src="assets/taskpoints-logo.png" alt="TaskPoints logo" class="w-10 h-10 rounded-2xl object-cover shrink-0 shadow-sm">
        <h1 class="text-2xl font-extrabold tracking-tight leading-tight">
          <span style="color:#fb923c;">Task</span><span style="color:#1e666d;">Points</span>
        </h1>
      </a>
      <div class="flex items-center gap-2">
        <button type="button" class="btn btn-ghost btn-toolbar" data-export-button>Export</button>
        <label class="btn btn-ghost btn-toolbar cursor-pointer">
          <span>Import</span>
          <input type="file" accept="application/json" class="hidden" data-import-input/>
        </label>
      </div>
    </div>
    <!-- Header / nav -->
    <header class="flex flex-wrap items-center justify-between gap-3 mb-4">
      <a href="index.html" class="hidden md:flex items-center gap-3">
        <img src="assets/taskpoints-logo.svg" alt="TaskPoints logo" class="w-9 h-9 rounded-2xl object-cover shadow-sm">
        <div>
          <h1 class="text-2xl sm:text-3xl font-extrabold tracking-tight">TaskPoints</h1>
          <p class="text-xs opacity-70">Game — Player Ratings</p>
        </div>
      </a>
      <div class="toolbar header-nav">
        <a href="index.html"         class="btn btn-teal btn-toolbar nav-btn">Main</a>
        <a href="daily_sources.html" class="btn btn-teal btn-toolbar nav-btn">Sources</a>
        <a href="log.html"           class="btn btn-teal btn-toolbar nav-btn">Log</a>
        <a href="week.html"          class="btn btn-teal btn-toolbar nav-btn">Week</a>
        <div class="dropdown">
          <button type="button" class="btn btn-teal btn-toolbar nav-btn dropdown-toggle active" data-dropdown-toggle aria-expanded="false">Game <span class="caret">▾</span></button>
          <div class="dropdown-menu">
            <a href="game.html"         class="btn btn-teal btn-toolbar nav-btn">Players</a>
            <a href="standings.html"    class="btn btn-teal btn-toolbar nav-btn">Standings</a>
            <a href="matchups.html"     class="btn btn-teal btn-toolbar nav-btn">Matchups</a>
            <a href="schedule.html"     class="btn btn-teal btn-toolbar nav-btn">Schedule</a>
            <a href="game_ratings.html" class="btn btn-teal btn-toolbar nav-btn active" aria-current="page">Ratings</a>
            <a href="records.html"      class="btn btn-teal btn-toolbar nav-btn">Records</a>
          </div>
        </div>
        <a href="projects.html" class="btn btn-teal btn-toolbar nav-btn">Projects</a>
        <a href="settings.html" class="btn btn-teal btn-toolbar nav-btn">Settings</a>

      </div>
    </header>

    <section class="card mb-6">
      <div class="flex items-center justify-between mb-3">
        <h2 class="font-semibold text-lg">Player Ratings Table</h2>
        <div class="flex items-center gap-3">
          <button type="button" class="btn btn-ghost btn-toolbar text-xs" data-export-ratings>
            Export Ratings (CSV)
          </button>
          <span id="playerCount" class="text-xs opacity-70"></span>
        </div>
      </div>
      <p class="text-xs opacity-70 mb-3">
        Click any column header to sort. Risky is shown as a 0–10 rating (normalized from your stored data). Variance Tilt shows the % of swings that land above a player’s baseline (50% = neutral).
      </p>

      <div class="overflow-x-auto">
        <table>
          <thead>
<tr>
  <th data-sort="name">Name</th>
  <th data-sort="baseline">Baseline</th>
  <th data-sort="variance">Variance</th>
  <th data-sort="varianceTilt">Variance Tilt</th>
  <th data-sort="momentum">Momentum</th>
  <th data-sort="risky">Risky</th>
  <th data-sort="style">Style</th>
</tr>

          </thead>
          <tbody id="playersTableBody">
            <!-- Rows injected by JS -->
          </tbody>
        </table>
      </div>
    </section>

    <footer class="mt-8 text-xs opacity-70">
      <p>TaskPoints — Player ratings view. Read-only; edit players on the main Game page.</p>
    </footer>
  </div>

  <script>
const STORAGE_KEY = "taskpoints_v1";
const $ = id => document.getElementById(id);

let latestState = null;  // <- new

function loadPlayers() {
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (!raw) return [];

    const parsed = JSON.parse(raw);
    latestState = parsed; // <- remember full state

    return Array.isArray(parsed.players) ? parsed.players : [];
  } catch (e) {
    console.error("Failed to load players from localStorage", e);
    latestState = null;
    return [];
  }
}

function computeYouStatsFromCompletions() {
  const s = latestState;
  const record = window.TaskPointsCore?.computeRecord
    ? TaskPointsCore.computeRecord(s, "YOU")
    : { wins: 0, losses: 0, games: 0, source: "unknown" };

  if (record.source === "matchups") {
    const matchups = Array.isArray(s?.matchups) ? s.matchups : [];
    let games = 0;
    let totalPoints = 0;

    for (const m of matchups) {
      if (!m || (m.playerAId !== "YOU" && m.playerBId !== "YOU")) continue;
      const aScore = Number(m.scoreA);
      const bScore = Number(m.scoreB);
      if (!Number.isFinite(aScore) || !Number.isFinite(bScore)) continue;
      const yourScore = m.playerAId === "YOU" ? aScore : bScore;
      totalPoints += yourScore;
      games++;
    }

    const avgPPD = games ? (totalPoints / games) : 0;
    const winPct = (record.wins + record.losses)
      ? (record.wins / (record.wins + record.losses)) * 100
      : null;
    const ppd = avgPPD;

    return {
      games,
      wins: record.wins,
      losses: record.losses,
      winPct,
      avgPPD,
      ppd
    };
  }

  if (!s || !Array.isArray(s.completions) || !s.completions.length) {
    return {
      games: 0,
      wins: 0,
      losses: 0,
      winPct: null,
      avgPPD: null,
      ppd: null
    };
  }

  const dayMap = {};
  for (const c of s.completions) {
    const day = c.completedAtISO
      ? (window.TaskPointsCore?.dateKey ? TaskPointsCore.dateKey(c.completedAtISO) : c.dateKey)
      : c.dateKey;
    if (!day) continue;
    const pts = window.TaskPointsCore?.pointsForCompletion
      ? TaskPointsCore.pointsForCompletion(c)
      : Number(c.points || 0);
    if (!dayMap[day]) dayMap[day] = 0;
    dayMap[day] += pts;
  }

  const dailyTotals = Object.values(dayMap);
  if (!dailyTotals.length) {
    return {
      games: 0,
      wins: 0,
      losses: 0,
      winPct: null,
      avgPPD: null,
      ppd: null
    };
  }

  const avgPPD =
    dailyTotals.reduce((sum, val) => sum + val, 0) / dailyTotals.length;

  const winPct = (record.wins + record.losses)
    ? (record.wins / (record.wins + record.losses)) * 100
    : null;

  const ppd = avgPPD;

  return {
    games: dailyTotals.length,
    wins: record.wins,
    losses: record.losses,
    winPct,
    avgPPD,
    ppd
  };
}


// existing helper
function getNormalizedRisky(rawRisky) {
  let n = Number(rawRisky);
  if (Number.isNaN(n)) return 0;
  if (n > 10) n = n / 10;
  if (n < 0) n = 0;
  if (n > 10) n = 10;
  return n;
}

let players = loadPlayers();

// Inject a special "You" row into the ratings table.
// Ratings fields (baseline, variance, etc.) stay blank, but stats are real.
const youRow = {
  id: "YOU",
  name: "You",
  baseline: null,
  variance: null,
  momentum: null,
  risky: null,
  style: "",
  isYou: true
};

players = [youRow, ...players];


// NEW: pull gameHistory off the last-loaded state
let gameHistory =
  latestState && Array.isArray(latestState.gameHistory)
    ? latestState.gameHistory
    : [];

let sortKey = "name";
let sortDir = "asc"; // "asc" or "desc"

function getSortedPlayers() {
  return [...players].sort((a, b) => {
    const ak = getSortValue(a, sortKey);
    const bk = getSortValue(b, sortKey);

    if (ak == null && bk == null) return 0;
    if (ak == null) return 1;
    if (bk == null) return -1;

    if (typeof ak === "number" && typeof bk === "number") {
      return sortDir === "asc" ? ak - bk : bk - ak;
    }

    const as = String(ak).toLowerCase();
    const bs = String(bk).toLowerCase();
    if (as < bs) return sortDir === "asc" ? -1 : 1;
    if (as > bs) return sortDir === "asc" ? 1 : -1;
    return 0;
  });
}

function downloadCsv(filename, rows) {
  const csvRows = rows.map(row => row.map(value => {
    if (value == null) return "";
    const str = String(value);
    if (/[",\n]/.test(str)) {
      return `"${str.replace(/"/g, '""')}"`;
    }
    return str;
  }).join(","));

  const csv = "\uFEFF" + csvRows.join("\n");
  const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
  const url = URL.createObjectURL(blob);
  const link = document.createElement("a");
  link.href = url;
  link.download = filename;
  document.body.appendChild(link);
  link.click();
  link.remove();
  URL.revokeObjectURL(url);
}

function exportRatingsCsv() {
  const rows = [["Name", "Baseline", "Variance", "Variance Tilt (%)", "Momentum", "Risky", "Style"]];

  getSortedPlayers().forEach(p => {
    const baseline = typeof p.baseline === "number" ? p.baseline : Number(p.baseline);
    const variance = typeof p.variance === "number" ? p.variance : Number(p.variance);
    const varianceTilt = typeof p.varianceTilt === "number" ? p.varianceTilt : Number(p.varianceTilt);
    const momentum = typeof p.momentum === "number" ? p.momentum : Number(p.momentum);
    const riskyNorm = getNormalizedRisky(p.risky);

    rows.push([
      p.name || "—",
      Number.isFinite(baseline) ? baseline : "",
      Number.isFinite(variance) ? variance : "",
      Number.isFinite(varianceTilt) ? varianceTilt : "",
      Number.isFinite(momentum) ? momentum : "",
      Number.isFinite(riskyNorm) ? riskyNorm.toFixed(1) : "",
      p.style || ""
    ]);
  });

  const now = new Date();
  const stamp = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, "0")}-${String(now.getDate()).padStart(2, "0")}`;
  downloadCsv(`taskpoints-player-ratings-${stamp}.csv`, rows);
}

function renderTable() {
  const tbody = $("playersTableBody");
  if (!tbody) return;
  tbody.innerHTML = "";

  const sorted = getSortedPlayers();

  sorted.forEach(p => {
    const tr = document.createElement("tr");

    const baseline =
      typeof p.baseline === "number" ? p.baseline : Number(p.baseline) || null;
    const variance =
      typeof p.variance === "number" ? p.variance : Number(p.variance) || null;
    const varianceTilt =
      typeof p.varianceTilt === "number"
        ? p.varianceTilt
        : Number(p.varianceTilt) || null;
    const momentum =
      typeof p.momentum === "number" ? p.momentum : Number(p.momentum) || null;
    const riskyNorm = getNormalizedRisky(p.risky);
    const style = p.style || "";

    const stats = computePlayerStats(p);


    tr.innerHTML = `
      <td class="pr-4">${escapeHtml(p.name || "—")}</td>
      <td>${baseline != null ? baseline : "—"}</td>
      <td>${variance != null ? variance : "—"}</td>
      <td>${varianceTilt != null ? `${varianceTilt}%` : "—"}</td>
      <td>${momentum != null ? momentum : "—"}</td>
      <td>${riskyNorm != null ? riskyNorm.toFixed(1) : "—"}</td>
      <td>${escapeHtml(style || "—")}</td>
    `;

    tbody.appendChild(tr);
  });

  const countLabel = $("playerCount");
  if (countLabel) {
    if (players.length) {
      countLabel.textContent = `${players.length} player${players.length === 1 ? "" : "s"}`;
    } else {
      countLabel.textContent = "No players found";
    }
  }

  updateSortIndicators();
}

function computePlayerStats(p) {
  // Special case: the real-you row uses TaskPoints completions,
  // not simulated gameHistory.
  if (p && (p.id === "YOU" || p.isYou)) {
    return computeYouStatsFromCompletions();
  }

  if (!Array.isArray(gameHistory) || !gameHistory.length) {
    return {
      games: 0,
      wins: 0,
      losses: 0,
      winPct: null,
      avgPPD: null,
      ppd: null
    };
  }

  let games = 0;
  let totalPoints = 0;
  let wins = 0;
  let losses = 0;

  const baseline =
    typeof p.baseline === "number" ? p.baseline : Number(p.baseline) || 0;

  for (const g of gameHistory) {
    if (g.playerId !== p.id) continue;

    games++;
    const score =
      typeof g.score === "number" ? g.score : Number(g.score) || 0;

    totalPoints += score;

    if (baseline) {
      if (score >= baseline) wins++;
      else losses++;
    }
  }

  if (!games) {
    return {
      games: 0,
      wins: 0,
      losses: 0,
      winPct: null,
      avgPPD: null,
      ppd: null
    };
  }

  const avgPPD = totalPoints / games;
  const winPct = (wins + losses) ? (wins / (wins + losses)) * 100 : null;
  const ppd = baseline ? avgPPD - baseline : null;

  return {
    games,
    wins,
    losses,
    winPct,
    avgPPD,
    ppd
  };
}



function getSortValue(p, key) {
  const stats = computePlayerStats(p);

  switch (key) {
    case "name":      return (p.name || "").toLowerCase();
    case "baseline":  return Number(p.baseline) || 0;
    case "variance":  return Number(p.variance) || 0;
    case "varianceTilt": return Number(p.varianceTilt) || 0;
    case "momentum":  return Number(p.momentum) || 0;
    case "risky":     return getNormalizedRisky(p.risky);
    case "style":     return (p.style || "").toLowerCase();
    case "wins":      return stats.wins || 0;
    case "losses":    return stats.losses || 0;
    case "winPct":    return stats.winPct || 0;
    case "ppd":       return stats.ppd || 0;
    case "avgPpd":    return stats.avgPPD || 0;
    default:          return 0;
  }
}


    function updateSortIndicators() {
      const indicators = document.querySelectorAll("[data-indicator]");
      indicators.forEach(span => {
        const key = span.getAttribute("data-indicator");
        if (key === sortKey) {
          span.textContent = sortDir === "asc" ? "▲" : "▼";
        } else {
          span.textContent = "";
        }
      });
    }

    function escapeHtml(str) {
      if (!str && str !== 0) return "";
      return String(str).replace(/[&<>"']/g, m => ({
        "&": "&amp;",
        "<": "&lt;",
        ">": "&gt;",
        '"': "&quot;",
        "'": "&#039;"
      }[m]));
    }

    // Hook up header click sorting
    document.addEventListener("DOMContentLoaded", () => {
      const exportButton = document.querySelector("[data-export-ratings]");
      if (exportButton) {
        exportButton.addEventListener("click", exportRatingsCsv);
      }

      const headers = document.querySelectorAll("th[data-sort]");
      headers.forEach(th => {
        th.addEventListener("click", () => {
          const key = th.getAttribute("data-sort");
          if (!key) return;

          if (sortKey === key) {
            // Toggle direction
            sortDir = sortDir === "asc" ? "desc" : "asc";
          } else {
            sortKey = key;
            sortDir = "asc";
          }

          renderTable();
        });
      });

      renderTable();
    });
  </script>

  <button
    class="hidden md:hidden fixed top-3 right-3 z-40 btn btn-teal rounded-full shadow-lg px-4 py-2 text-sm flex items-center gap-1"
    type="button"
    data-scroll-top
  >
    <span>⬆️</span>
    <span>Top</span>
  </button>
</body>
</html>


