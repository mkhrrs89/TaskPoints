<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>TaskPoints — Projects</title>

  <!-- Tailwind (matches the rest of your app setup) -->
  
  <!-- Your shared app styles -->
  <link rel="stylesheet" href="assets/tailwind.css">
  <link rel="stylesheet" href="styles.css" />
  <link rel="preload" href="toolbar.js" as="script">
  <script src="toolbar.js" defer></script>

  /* Mobile stats: one horizontal row */
  body.projects-compact .summaryRow{
    -ms-overflow-style: none;     /* IE/Edge */
    scrollbar-width: none;        /* Firefox */
  }
  body.projects-compact .summaryRow::-webkit-scrollbar{
    display:none;                 /* Chrome/Safari */
  }

  
  <style>
  /* Keep Projects page styling minimal so it inherits the main site vibe */

  /* Modal */
  .modalWrap{
    position: fixed;
    inset: 0;
    display: none;
    align-items: center;
    justify-content: center;
    background: rgba(0,0,0,0.55);
    z-index: 80;
    padding: 20px;
  }
  .modalWrap.show{ display:flex; }
  .modalPanel{
    width: min(720px, 96vw);
    background: rgba(16,16,24,0.92);
    border: 1px solid var(--border);
    border-radius: 20px;
    padding: 18px;
    box-shadow: 0 20px 60px rgba(0,0,0,0.45);
  }

  /* Subtask checkbox sizing */
  .subtaskRow input[type="checkbox"]{
    width: 18px;
    height: 18px;
    accent-color: #22c55e;
  }

  /* ==============================
     Projects-only compact mode
     ============================== */
  body.projects-compact { font-size: 0.95rem; }

  body.projects-compact .glass{
    padding: 12px;
    border-radius: 16px;
  }

  body.projects-compact .btn{
    padding: 6px 10px;
    border-radius: 11px;
  }

  body.projects-compact .btn-toolbar{
    padding: 5px 7px;
    font-size: 10px;
  }

  body.projects-compact .tag{
    padding: 1px 6px;
    font-size: 11px;
  }

  body.projects-compact .input,
  body.projects-compact select,
  body.projects-compact textarea{
    padding: 8px 10px;
    border-radius: 11px;
  }

  body.projects-compact .today-breakdown-bar{ height: 10px; }

  body.projects-compact .modalWrap{ padding: 12px; }
  body.projects-compact .modalPanel{ padding: 14px; border-radius: 18px; }
</style>


</head>

  <body class="min-h-screen projects-compact">
  <div class="mx-auto max-w-6xl p-3 sm:p-4 pb-16 md:pb-5">

    <div class="flex items-center justify-between gap-3 mb-3 md:hidden">
      <a href="index.html" class="flex items-center gap-3">
        <img src="assets/taskpoints-logo.png" alt="TaskPoints logo" class="w-10 h-10 rounded-2xl object-cover shrink-0 shadow-sm">
        <h1 class="text-2xl font-extrabold tracking-tight leading-tight">
          <span style="color:#fb923c;">Task</span><span style="color:#1e666d;">Points</span>
        </h1>
      </a>
      <div class="flex items-center gap-2">
        <button type="button" class="btn btn-ghost btn-toolbar" data-export-button>Export</button>
        <label class="btn btn-ghost btn-toolbar cursor-pointer">
          <span>Import</span>
          <input type="file" accept="application/json" class="hidden" data-import-input/>
        </label>
      </div>
    </div>

    <!-- Header (kept consistent with your app vibe) -->
    <header class="mb-3">
      <div class="row items-center gap-3 sm:gap-4">
        <div class="flex items-center gap-3 flex-1 min-w-0">
          <div class="hidden md:block p-2 rounded-2xl bg-slate-900/50 border border-slate-700/60 shadow-inner">
            <img src="assets/taskpoints-logo.png" alt="TaskPoints logo" class="w-10 h-10 rounded-2xl object-cover shrink-0">
          </div>
          <div class="min-w-0">
            <h1 class="text-2xl sm:text-3xl font-extrabold tracking-tight flex items-center gap-2 page-title">Projects</h1>
          </div>
        </div>

        <div class="toolbar header-nav mt-3 sm:mt-0">
          <a href="index.html"         class="btn btn-teal btn-toolbar nav-btn">Main</a>
          <a href="today.html" class="btn btn-teal btn-toolbar nav-btn">Today</a>
          <a href="daily_sources.html" class="btn btn-teal btn-toolbar nav-btn">Sources</a>
          <a href="log.html"           class="btn btn-teal btn-toolbar nav-btn">Log</a>
          <a href="week.html"          class="btn btn-teal btn-toolbar nav-btn">Week</a>

          <div class="dropdown hidden md:block">
            <button type="button" class="btn btn-teal btn-toolbar dropdown-toggle nav-btn" data-dropdown-toggle aria-expanded="false">
              Game <span class="caret">▾</span>
            </button>
            <div class="dropdown-menu">
              <a href="gamehub.html" class="btn btn-teal btn-toolbar nav-btn">Game Hub</a>
              <a href="game.html"         class="btn btn-teal btn-toolbar nav-btn">Players</a>
              <a href="standings.html"    class="btn btn-teal btn-toolbar nav-btn">Standings</a>
              <a href="matchups.html"     class="btn btn-teal btn-toolbar nav-btn">Matchups</a>
              <a href="schedule.html"     class="btn btn-teal btn-toolbar nav-btn">Schedule</a>
              <a href="game_ratings.html" class="btn btn-teal btn-toolbar nav-btn">Ratings</a>
              <a href="records.html"      class="btn btn-teal btn-toolbar nav-btn">Records</a>
            </div>
          </div>

          <a href="projects.html" class="btn btn-teal btn-toolbar nav-btn active">Projects</a>
          <a href="settings.html" class="btn btn-teal btn-toolbar nav-btn">Settings</a>
        </div>
      </div>
    </header>

    <!-- Controls -->
    <section class="glass mb-3">
<div class="grid gap-2">
  <!-- Row 1: Search + Add -->
  <div class="grid grid-cols-[1fr_auto] gap-2 items-end">
    <div class="min-w-0">
      <label class="muted">Search</label>
      <input id="searchInput" class="input w-full" placeholder="Find a project…" />
    </div>
    <div>
      <button id="addProjectBtn" class="btn btn-teal whitespace-nowrap">+ Add Project</button>
    </div>
  </div>

  <!-- Row 2: Category + Sort -->
  <div class="grid grid-cols-2 gap-2 items-end">
    <div class="min-w-0">
      <label class="muted">Category</label>
      <select id="categoryFilter" class="input w-full">
        <option value="">All</option>
      </select>
    </div>

    <div class="min-w-0">
      <label class="muted">Sort</label>
      <select id="sortSelect" class="input w-full">
        <option value="updated_desc">Recently updated</option>
        <option value="progress_desc">Most done</option>
        <option value="progress_asc">Least done</option>
        <option value="name_asc">Name (A → Z)</option>
        <option value="name_desc">Name (Z → A)</option>
        <option value="category_asc">Category (A → Z)</option>
      </select>
    </div>
  </div>
</div>

    </section>

    <section id="summaryStats" class="mb-3"></section>

    <!-- List -->
    <section id="listWrap" class="grid gap-2"></section>

    <!-- Empty state -->
    <div id="emptyState" class="glass hidden">
      <div class="text-base font-semibold mb-1">No projects yet</div>
      <div class="muted mb-2">Add one and start chipping away. Little by little = unstoppable.</div>
      <button class="btn btn-teal" id="emptyAddBtn">+ Add your first project</button>
    </div>
  </div>

  <!-- Modal -->
  <div id="modal" class="modalWrap" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modalPanel">
      <div class="flex items-start justify-between gap-3">
        <div>
          <div id="modalTitle" class="text-xl font-extrabold">Add Project</div>
          <div class="muted">Progress is saved locally (separate from points for now).</div>
        </div>
        <button id="closeModalBtn" class="btn btn-ghost">✕</button>
      </div>

      <div class="grid sm:grid-cols-2 gap-3 mt-4">
        <div class="sm:col-span-2">
          <label class="muted">Project name</label>
          <input id="projName" class="input w-full" placeholder="e.g., Finish Christmas shopping" />
        </div>

        <div>
          <label class="muted">Category</label>
          <input id="projCategory" class="input w-full" list="categoryList" placeholder="e.g., Home, Art, Life Admin" />
          <datalist id="categoryList"></datalist>
        </div>

        <div>
          <label class="muted">Starting progress (0–100)</label>
          <input id="projProgress" class="input w-full" type="number" min="0" max="100" value="0" />
        </div>

        <div class="sm:col-span-2">
          <label class="muted">Notes</label>
          <textarea id="projNotes" class="input w-full" rows="3" placeholder="Optional… brain dump, plan, links to stuff, etc."></textarea>
        </div>

        <div class="sm:col-span-2">
          <label class="muted">Subtasks (one per line)</label>
          <textarea id="projSubtasks" class="input w-full" rows="4" placeholder="Call florist&#10;Order frame&#10;Clean closet top shelf"></textarea>
        </div>
      </div>

      <div class="flex flex-col sm:flex-row gap-2 sm:justify-end mt-4">
        <button id="deleteBtn" class="btn btn-danger hidden">Delete</button>
        <button id="cancelBtn" class="btn btn-ghost">Cancel</button>
        <button id="saveBtn" class="btn btn-warn">Save</button>
      </div>
    </div>
  </div>

<script>
/* -----------------------------
   Projects mini-app (standalone)
------------------------------*/
const STORAGE_KEY = "tp_projects_v1";

const $ = (id) => document.getElementById(id);

function makeId(){
  if (window.crypto && typeof crypto.randomUUID === "function") return crypto.randomUUID();
  return "id_" + Date.now().toString(36) + "_" + Math.random().toString(36).slice(2);
}

function loadProjects(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    const arr = raw ? JSON.parse(raw) : [];
    return Array.isArray(arr) ? arr : [];
  }catch(e){
    console.error("projects load error", e);
    return [];
  }
}

function saveProjects(){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(state.projects));
}

function clamp(n, min, max){
  n = Number(n);
  if (Number.isNaN(n)) return min;
  return Math.max(min, Math.min(max, n));
}

function normCat(s){
  return (s || "").trim();
}

function titleCaseLoose(s){
  // light touch; don't over-style user text
  return (s || "").trim();
}

const state = {
  projects: loadProjects(),
  ui: {
    filterCat: "",
    search: "",
    sort: "updated_desc",
    openId: null, // which project is expanded
    editingId: null
  }
};

/* -----------------------------
   Rendering
------------------------------*/
function getCategories(){
  const set = new Set();
  state.projects.forEach(p => {
    const c = normCat(p.category);
    if (c) set.add(c);
  });
  return Array.from(set).sort((a,b)=>a.localeCompare(b));
}

function applyFilters(list){
  const q = state.ui.search.toLowerCase().trim();
  const cat = state.ui.filterCat;

  return list.filter(p => {
    const matchesCat = !cat || normCat(p.category) === cat;
    const matchesQ = !q || (
      (p.name || "").toLowerCase().includes(q) ||
      (p.notes || "").toLowerCase().includes(q) ||
      (normCat(p.category) || "").toLowerCase().includes(q) ||
      (p.subtasks || []).some(st => (st.text || "").toLowerCase().includes(q))
    );
    return matchesCat && matchesQ;
  });
}

function applySort(list){
  const s = state.ui.sort;
  const copy = list.slice();

  const byName = (a,b) => (a.name||"").localeCompare(b.name||"");
  const byCat  = (a,b) => (normCat(a.category)||"").localeCompare(normCat(b.category)||"");
  const byUpd  = (a,b) => (b.updatedAt||0) - (a.updatedAt||0);

  if (s === "updated_desc") return copy.sort(byUpd);
  if (s === "progress_desc") return copy.sort((a,b)=> (b.done||0) - (a.done||0) || byUpd(a,b));
  if (s === "progress_asc")  return copy.sort((a,b)=> (a.done||0) - (b.done||0) || byUpd(a,b));
  if (s === "name_asc")      return copy.sort((a,b)=> byName(a,b) || byUpd(a,b));
  if (s === "name_desc")     return copy.sort((a,b)=> byName(b,a) || byUpd(a,b));
  if (s === "category_asc")  return copy.sort((a,b)=> byCat(a,b) || byName(a,b) || byUpd(a,b));
  return copy.sort(byUpd);
}

function renderFilters(){
  // category dropdown + datalist for modal
  const cats = getCategories();
  const filter = $("categoryFilter");
  const list = $("categoryList");

  if (filter){
    const current = state.ui.filterCat;
    filter.innerHTML = `<option value="">All</option>` + cats.map(c =>
      `<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`
    ).join("");
    filter.value = current;
  }
  if (list){
    list.innerHTML = cats.map(c => `<option value="${escapeHtml(c)}"></option>`).join("");
  }
}

function renderSummary(list){
  const wrap = $("summaryStats");
  if (!wrap) return;

  const total = state.projects.length;
  const filtered = list.length;
  const avg = filtered ? Math.round(list.reduce((sum,p)=> sum + clamp(p.done ?? 0, 0, 100), 0) / filtered) : 0;
  const open = list.filter(p => clamp(p.done ?? 0, 0, 100) < 100).length;
  const catCount = getCategories().length;
  const latestTs = list.reduce((max, p) => Math.max(max, p.updatedAt || 0), 0);

  wrap.innerHTML = `
    <div class="summaryRow flex gap-2 overflow-x-auto pb-1 -mx-1 px-1 sm:mx-0 sm:px-0 sm:pb-0 sm:grid sm:overflow-visible sm:grid-cols-2 lg:grid-cols-5">
      <div class="glass shrink-0 w-44 sm:w-auto">
        <div class="muted text-xs">Visible</div>
        <div class="text-xl font-extrabold mt-0.5">
          ${filtered || 0} <span class="muted text-xs font-semibold">of ${total || 0}</span>
        </div>
      </div>

      <div class="glass shrink-0 w-44 sm:w-auto">
        <div class="muted text-xs">Avg progress</div>
        <div class="text-xl font-extrabold mt-0.5">${avg}%</div>
      </div>

      <div class="glass shrink-0 w-44 sm:w-auto">
        <div class="muted text-xs">In motion</div>
        <div class="text-xl font-extrabold mt-0.5">${open}</div>
      </div>

      <div class="glass shrink-0 w-44 sm:w-auto">
        <div class="muted text-xs">Categories</div>
        <div class="text-xl font-extrabold mt-0.5">${catCount || 0}</div>
      </div>

      <div class="glass shrink-0 w-44 sm:w-auto">
        <div class="muted text-xs">Last touch</div>
        <div class="font-semibold mt-0.5">${latestTs ? timeAgo(latestTs) : "—"}</div>
      </div>
    </div>
  `;

}

function renderList(){
  const wrap = $("listWrap");
  const empty = $("emptyState");
  if (!wrap) return;

  renderFilters();

  const filtered = applySort(applyFilters(state.projects));

  renderSummary(filtered);

  wrap.innerHTML = "";

  if (!filtered.length){
    empty?.classList.remove("hidden");
    return;
  }
  empty?.classList.add("hidden");

  filtered.forEach(p => {
    const done = clamp(p.done ?? 0, 0, 100);
    const percent = done;
    const isOpen = state.ui.openId === p.id;

    const subtasks = Array.isArray(p.subtasks) ? p.subtasks : [];
    const doneSubs = subtasks.filter(s=>s.done).length;

    const card = document.createElement("div");
    card.className = "glass";

    card.innerHTML = `
      <div class="flex items-start justify-between gap-2 flex-wrap">
        <div class="min-w-0 space-y-0.5">
          <div class="flex items-center gap-2 flex-wrap">
            <div class="text-base font-extrabold break-words">${escapeHtml(p.name || "Untitled Project")}</div>
            ${p.category ? `<span class="tag tag-clear">${escapeHtml(p.category)}</span>` : ""}
          </div>
<div class="muted flex items-center gap-2 flex-wrap">
  <span class="tag tag-clear">Updated ${timeAgo(p.updatedAt)}</span>
  <span class="tag tag-clear">Subtasks ${doneSubs}/${subtasks.length || 0}</span>
</div>

        </div>

        <div class="flex gap-2 shrink-0">
          <button class="btn btn-ghost btn-toolbar" data-action="toggle" data-id="${p.id}">${isOpen ? "Hide" : "Details"}</button>
          <button class="btn btn-ghost btn-toolbar" data-action="edit" data-id="${p.id}">Edit</button>
        </div>
      </div>

      <div class="mt-1 space-y-1">
        <div class="grid sm:grid-cols-3 gap-1.5 items-center">
          <div class="sm:col-span-2">
            <div class="flex items-center justify-between">
              <div class="muted">Completion</div>
              <div class="font-extrabold">${percent}%</div>
            </div>
<div class="today-breakdown-bar mt-1" aria-label="progress bar">
  <div class="todayBreakdown-seg todayBreakdown-tasks" style="width:${percent}%"></div>
</div>

          </div>
<div>
  <div class="muted text-xs">At a glance</div>
  <div class="font-semibold text-sm mt-1">${subtasks.length ? `${doneSubs}/${subtasks.length} subtasks` : "No subtasks"}</div>
</div>

        </div>

        <div class="flex items-center gap-1.5 flex-wrap">
          <span class="tag">Quick</span>
          <button class="btn btn-ghost btn-toolbar" data-action="bump" data-id="${p.id}" data-delta="-10">-10</button>
          <button class="btn btn-ghost btn-toolbar" data-action="bump" data-id="${p.id}" data-delta="-5">-5</button>
          <button class="btn btn-ghost btn-toolbar" data-action="bump" data-id="${p.id}" data-delta="-1">-1</button>
          <button class="btn btn-ghost btn-toolbar" data-action="bump" data-id="${p.id}" data-delta="1">+1</button>
          <button class="btn btn-ghost btn-toolbar" data-action="bump" data-id="${p.id}" data-delta="5">+5</button>
          <button class="btn btn-ghost btn-toolbar" data-action="bump" data-id="${p.id}" data-delta="10">+10</button>
          <div class="flex items-center gap-2 ml-auto">
            <span class="muted">Set</span>
            <input class="input w-20" type="number" min="0" max="100" value="${percent}" data-action="setInput" data-id="${p.id}">
          </div>
        </div>


      </div>

      <div class="${isOpen ? "" : "hidden"} mt-3" data-open-panel="${p.id}">
        <div class="grid sm:grid-cols-2 gap-2">
          <div class="sm:col-span-2">
            <label class="muted">Notes</label>
            <textarea class="input w-full" rows="3" data-action="notes" data-id="${p.id}" placeholder="Add notes…">${escapeHtml(p.notes || "")}</textarea>
          </div>

          <div class="sm:col-span-2">
            <div class="flex items-center justify-between mb-1.5">
              <div class="font-semibold">Subtasks</div>
              <div class="muted">${doneSubs}/${subtasks.length || 0} done</div>
            </div>

            <div class="grid gap-1.5" data-subtasks="${p.id}">
              ${subtasks.length ? subtasks.map(st => `
                <div class="subtaskRow flex items-center gap-2">
                  <input type="checkbox" ${st.done ? "checked" : ""} data-action="toggleSub" data-id="${p.id}" data-subid="${st.id}">
                  <input class="input w-full" value="${escapeHtml(st.text || "")}" data-action="editSubText" data-id="${p.id}" data-subid="${st.id}" />
                  <button class="btn btn-ghost" data-action="delSub" data-id="${p.id}" data-subid="${st.id}">✕</button>
                </div>
              `).join("") : `<div class="muted">No subtasks yet. Add one below.</div>`}
            </div>

            <div class="flex gap-2 mt-2">
              <input class="input w-full" placeholder="New subtask…" data-action="newSubText" data-id="${p.id}">
              <button class="btn btn-warn btn-toolbar" data-action="addSub" data-id="${p.id}">Add</button>
            </div>
          </div>
        </div>

        <div class="flex justify-end mt-3">
          <button class="btn btn-danger" data-action="delete" data-id="${p.id}">Delete Project</button>
        </div>
      </div>
    `;

    wrap.appendChild(card);
  });
}

function escapeHtml(s){
  return String(s ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#39;");
}

function timeAgo(ts){
  if (!ts) return "—";
  const diff = Date.now() - ts;
  const m = Math.floor(diff / 60000);
  if (m < 1) return "just now";
  if (m < 60) return `${m}m ago`;
  const h = Math.floor(m / 60);
  if (h < 24) return `${h}h ago`;
  const d = Math.floor(h / 24);
  return `${d}d ago`;
}

/* -----------------------------
   Mutations
------------------------------*/
function touch(p){
  p.updatedAt = Date.now();
}

function bumpProgress(id, delta){
  const p = state.projects.find(x=>x.id===id);
  if (!p) return;
  p.done = clamp((p.done ?? 0) + delta, 0, 100);
  touch(p);
  saveProjects();
  renderList();
}

function setProgress(id, value){
  const p = state.projects.find(x=>x.id===id);
  if (!p) return;
  p.done = clamp(value, 0, 100);
  touch(p);
  saveProjects();
  renderList();
}

function toggleOpen(id){
  state.ui.openId = (state.ui.openId === id) ? null : id;
  renderList();
}

/* -----------------------------
   Modal (Add/Edit)
------------------------------*/
function openModal(mode, projectId=null){
  const modal = $("modal");
  modal.classList.add("show");
  modal.setAttribute("aria-hidden","false");
  window.lockScrollForModal?.();

  const isEdit = mode === "edit";
  state.ui.editingId = isEdit ? projectId : null;

  $("modalTitle").textContent = isEdit ? "Edit Project" : "Add Project";
  $("deleteBtn").classList.toggle("hidden", !isEdit);

  const p = isEdit ? state.projects.find(x=>x.id===projectId) : null;

  $("projName").value = p ? (p.name || "") : "";
  $("projCategory").value = p ? (p.category || "") : "";
  $("projProgress").value = p ? clamp(p.done ?? 0, 0, 100) : 0;
  $("projNotes").value = p ? (p.notes || "") : "";
  $("projSubtasks").value = p ? (Array.isArray(p.subtasks) ? p.subtasks.map(s=>s.text||"").join("\n") : "") : "";

  // focus
  setTimeout(()=> $("projName")?.focus(), 50);
}

function closeModal(){
  const modal = $("modal");
  modal.classList.remove("show");
  modal.setAttribute("aria-hidden","true");
  state.ui.editingId = null;
  window.unlockScrollForModal?.();
}

function upsertFromModal(){
  const name = titleCaseLoose($("projName").value);
  if (!name) return alert("Project name is required.");

  const category = normCat($("projCategory").value);
  const done = clamp($("projProgress").value, 0, 100);
  const notes = $("projNotes").value || "";

  const rawLines = ($("projSubtasks").value || "").split("\n").map(x=>x.trim()).filter(Boolean);
  const subtasks = rawLines.map(t => ({ id: makeId(), text: t, done: false }));

  const now = Date.now();

  if (state.ui.editingId){
    const p = state.projects.find(x=>x.id===state.ui.editingId);
    if (!p) return;

    // keep existing subtasks if user didn't supply lines? (we'll replace if they did)
    // For now: if they typed anything, replace; if empty, keep current.
    const replaceSubs = rawLines.length > 0;

    p.name = name;
    p.category = category;
    p.done = done;
    p.notes = notes;
    if (replaceSubs) p.subtasks = subtasks;

    p.updatedAt = now;

  } else {
    state.projects.unshift({
      id: makeId(),
      name,
      category,
      done,
      notes,
      subtasks,
      createdAt: now,
      updatedAt: now
    });
  }

  saveProjects();
  closeModal();
  renderList();
}

/* -----------------------------
   Subtasks + notes inline
------------------------------*/
function toggleSub(projectId, subId, checked){
  const p = state.projects.find(x=>x.id===projectId);
  if (!p || !Array.isArray(p.subtasks)) return;
  const s = p.subtasks.find(x=>x.id===subId);
  if (!s) return;
  s.done = !!checked;
  touch(p);
  saveProjects();
  renderList();
}

function editSubText(projectId, subId, text){
  const p = state.projects.find(x=>x.id===projectId);
  if (!p || !Array.isArray(p.subtasks)) return;
  const s = p.subtasks.find(x=>x.id===subId);
  if (!s) return;
  s.text = text;
  touch(p);
  saveProjects();
  // no full rerender needed, but keep simple:
  // (still safe; list isn't huge)
  renderList();
}

function delSub(projectId, subId){
  const p = state.projects.find(x=>x.id===projectId);
  if (!p || !Array.isArray(p.subtasks)) return;
  p.subtasks = p.subtasks.filter(x=>x.id!==subId);
  touch(p);
  saveProjects();
  renderList();
}

function addSub(projectId, text){
  const p = state.projects.find(x=>x.id===projectId);
  if (!p) return;
  p.subtasks = Array.isArray(p.subtasks) ? p.subtasks : [];
  p.subtasks.push({ id: makeId(), text: text.trim(), done: false });
  touch(p);
  saveProjects();
  renderList();
}

function saveNotes(projectId, notes){
  const p = state.projects.find(x=>x.id===projectId);
  if (!p) return;
  p.notes = notes;
  touch(p);
  saveProjects();
  // don't rerender while typing; blur saves
}

/* -----------------------------
   Delete
------------------------------*/
function deleteProject(id){
  const p = state.projects.find(x=>x.id===id);
  const name = p?.name || "this project";
  if (!confirm(`Delete "${name}"?`)) return;
  state.projects = state.projects.filter(x=>x.id!==id);
  saveProjects();
  renderList();
}

/* -----------------------------
   Events
------------------------------*/
document.addEventListener("click", (e) => {
  const btn = e.target.closest("[data-action]");
  if (!btn) return;

  const action = btn.getAttribute("data-action");
  const id = btn.getAttribute("data-id");

  if (action === "toggle") return toggleOpen(id);
  if (action === "edit") return openModal("edit", id);
  if (action === "delete") return deleteProject(id);

  if (action === "bump") {
    const delta = Number(btn.getAttribute("data-delta") || 0);
    return bumpProgress(id, delta);
  }

  if (action === "addSub") {
    const input = btn.parentElement.querySelector('[data-action="newSubText"][data-id="'+id+'"]');
    const text = input?.value || "";
    if (!text.trim()) return;
    addSub(id, text);
    return;
  }

  if (action === "delSub") {
    const subid = btn.getAttribute("data-subid");
    return delSub(id, subid);
  }
});

document.addEventListener("input", (e) => {
  const el = e.target;

  if (el?.id === "searchInput"){
    state.ui.search = el.value || "";
    renderList();
    return;
  }

  if (el?.id === "sortSelect"){
    state.ui.sort = el.value;
    renderList();
    return;
  }

  if (el?.id === "categoryFilter"){
    state.ui.filterCat = el.value || "";
    renderList();
    return;
  }

  const action = el.getAttribute?.("data-action");
  const id = el.getAttribute?.("data-id");


  if (action === "setInput") return setProgress(id, el.value);
  if (action === "setRange") return setProgress(id, el.value);

  if (action === "notes"){
    // save lazily on blur; no action here
    return;
  }

  if (action === "editSubText"){
    const subid = el.getAttribute("data-subid");
    return editSubText(id, subid, el.value || "");
  }
});

document.addEventListener("change", (e) => {
  const el = e.target;
  const action = el.getAttribute?.("data-action");
  const id = el.getAttribute?.("data-id");

  if (action === "toggleSub"){
    const subid = el.getAttribute("data-subid");
    return toggleSub(id, subid, el.checked);
  }
});

document.addEventListener("blur", (e) => {
  const el = e.target;
  const action = el.getAttribute?.("data-action");
  const id = el.getAttribute?.("data-id");
  if (action === "notes"){
    return saveNotes(id, el.value || "");
  }
}, true);

/* Modal wiring */
$("addProjectBtn")?.addEventListener("click", () => openModal("add"));
$("emptyAddBtn")?.addEventListener("click", () => openModal("add"));
$("cancelBtn")?.addEventListener("click", closeModal);
$("closeModalBtn")?.addEventListener("click", closeModal);

$("saveBtn")?.addEventListener("click", upsertFromModal);

$("deleteBtn")?.addEventListener("click", () => {
  const id = state.ui.editingId;
  if (id) deleteProject(id);
  closeModal();
});

// Close modal when clicking outside panel
$("modal")?.addEventListener("click", (e) => {
  if (e.target.id === "modal") closeModal();
});

// Esc to close modal
document.addEventListener("keydown", (e) => {
  if (e.key === "Escape" && $("modal")?.classList.contains("show")){
    closeModal();
  }
});

/* Dropdown support (matches your existing dropdown behavior) */
document.addEventListener("click", (e) => {
  const toggle = e.target.closest("[data-dropdown-toggle]");
  const openMenus = document.querySelectorAll(".dropdown-menu.open");
  openMenus.forEach(m => {
    if (!m.contains(e.target) && !toggle?.closest(".dropdown")?.contains(e.target)){
      m.classList.remove("open");
      m.style.display = "none";
    }
  });

  if (!toggle) return;
  const dropdown = toggle.closest(".dropdown");
  const menu = dropdown?.querySelector(".dropdown-menu");
  if (!menu) return;

  const isOpen = menu.classList.contains("open");
  if (isOpen){
    menu.classList.remove("open");
    menu.style.display = "none";
    toggle.setAttribute("aria-expanded","false");
  }else{
    menu.classList.add("open");
    menu.style.display = "block";
    toggle.setAttribute("aria-expanded","true");
  }
});

/* Initial paint */
(function init(){
  $("sortSelect").value = state.ui.sort;
  renderList();
})();
</script>

  <button
    class="hidden md:hidden fixed top-3 right-3 z-40 btn btn-teal rounded-full shadow-lg px-4 py-2 text-sm flex items-center gap-1"
    type="button"
    data-scroll-top
  >
    <span>⬆️</span>
    <span>Top</span>
  </button>
  <div id="bottomToolbarMount"></div>
</body>
</html>
