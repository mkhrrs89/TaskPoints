<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>TaskPoints — Standings</title>

  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <meta name="apple-mobile-web-app-title" content="TaskPoints" />

  <!-- Simple TP icon (same as other pages) -->
  <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' width='256' height='256'><rect width='256' height='256' fill='%230b0d10'/><text x='128' y='160' text-anchor='middle' font-size='150' fill='white'>TP</text></svg>">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><circle cx='50' cy='50' r='48' fill='%230b0d10'/><text x='50' y='62' font-size='60' text-anchor='middle' fill='white'>TP</text></svg>">

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="scoring_core.js"></script>
  <link rel="stylesheet" href="styles.css">
  <script src="toolbar.js" defer></script>

  <style>
    body{
      background:#fafafa;
      color:#111827;
    }
    @media (prefers-color-scheme: dark) {
      body{
        background:#0a0a0a;
        color:#fafafa;
      }
    }

    .card{
      border:1px solid rgb(228 228 231);
      background:rgba(255,255,255,0.85);
      border-radius:16px;
      padding:16px;
      box-shadow:0 10px 30px rgba(0,0,0,0.12);
      backdrop-filter:blur(10px);
    }
    @media (prefers-color-scheme: dark) {
      .card{
        border-color:rgb(39 39 42);
        background:rgba(24,24,27,0.9);
      }
    }

    table{
      width:100%;
      border-collapse:collapse;
      font-size:13px;
    }
    thead{
      border-bottom:1px solid rgba(148,163,184,0.4);
    }
    th, td{
      padding:6px 8px;
      text-align:left;
      white-space:nowrap;
    }
    th{
      font-size:12px;
      text-transform:uppercase;
      letter-spacing:0.06em;
      opacity:0.75;
      cursor:pointer;
      user-select:none;
    }
    tbody tr:nth-child(2n){
      background:rgba(148,163,184,0.05);
    }
    @media (prefers-color-scheme: dark){
      tbody tr:nth-child(2n){
        background:rgba(3,32,32,0.9);
      }
    }
    .sort-indicator{
      font-size:10px;
      opacity:0.8;
      margin-left:4px;
    }
  </style>
</head>

<body class="min-h-screen">
  <div class="mx-auto max-w-6xl p-4 sm:p-6">

    <div class="flex items-center justify-between gap-3 mb-3 md:hidden">
      <a href="index.html" class="flex items-center gap-3">
        <img src="assets/taskpoints-logo.png" alt="TaskPoints logo" class="w-10 h-10 rounded-2xl object-cover shrink-0 shadow-sm">
        <h1 class="text-2xl font-extrabold tracking-tight leading-tight">
          <span style="color:#fb923c;">Task</span><span style="color:#1e666d;">Points</span>
        </h1>
      </a>
      <div class="flex items-center gap-2">
        <button type="button" class="btn btn-ghost btn-toolbar" data-export-button>Export</button>
        <label class="btn btn-ghost btn-toolbar cursor-pointer">
          <span>Import</span>
          <input type="file" accept="application/json" class="hidden" data-import-input/>
        </label>
      </div>
    </div>

    <!-- Header / nav -->
    <header class="flex flex-wrap items-center justify-between gap-3 mb-4">
      <a href="index.html" class="hidden md:flex items-center gap-3">
        <img src="assets/taskpoints-logo.svg" alt="TaskPoints logo" class="w-9 h-9 rounded-2xl object-cover shadow-sm">
        <div>
          <h1 class="text-2xl sm:text-3xl font-extrabold tracking-tight">TaskPoints</h1>
          <p class="text-xs opacity-70">Game — Standings</p>
        </div>
      </a>

      <div class="toolbar header-nav">
        <a href="index.html"         class="btn btn-teal btn-toolbar nav-btn">Main</a>
        <a href="today.html" class="btn btn-teal btn-toolbar nav-btn">Today</a>
        <a href="daily_sources.html" class="btn btn-teal btn-toolbar nav-btn">Sources</a>
        <a href="log.html"           class="btn btn-teal btn-toolbar nav-btn">Log</a>
        <a href="week.html"          class="btn btn-teal btn-toolbar nav-btn">Week</a>

        <div class="dropdown">
          <button type="button" class="btn btn-teal btn-toolbar nav-btn dropdown-toggle active" data-dropdown-toggle aria-expanded="false">Game <span class="caret">▾</span></button>
          <div class="dropdown-menu">
            <a href="gamehub.html" class="btn btn-teal btn-toolbar nav-btn">Game Hub</a>
            <a href="game.html"         class="btn btn-teal btn-toolbar nav-btn">Players</a>
            <a href="standings.html"    class="btn btn-teal btn-toolbar nav-btn active" aria-current="page">Standings</a>
            <a href="matchups.html"     class="btn btn-teal btn-toolbar nav-btn">Matchups</a>
            <a href="schedule.html"     class="btn btn-teal btn-toolbar nav-btn">Schedule</a>
            <a href="game_ratings.html" class="btn btn-teal btn-toolbar nav-btn">Ratings</a>
            <a href="records.html"      class="btn btn-teal btn-toolbar nav-btn">Records</a>
          </div>
        </div>

        <a href="projects.html" class="btn btn-teal btn-toolbar nav-btn">Projects</a>

        <a href="settings.html" class="btn btn-teal btn-toolbar nav-btn">Settings</a>
      </div>
    </header>

    <section class="card mb-6">
      <div class="flex items-center justify-between mb-3">
        <h2 class="font-semibold text-lg">Standings</h2>
        <span id="playerCount" class="text-xs opacity-70"></span>
      </div>

      <p class="text-xs opacity-70 mb-3">
        Click any column header to sort.
      </p>

      <div class="overflow-x-auto">
        <table>
          <thead>
            <tr>
              <th data-sort="name">Name <span class="sort-indicator" data-indicator="name"></span></th>
              <th data-sort="wins">W <span class="sort-indicator" data-indicator="wins"></span></th>
              <th data-sort="losses">L <span class="sort-indicator" data-indicator="losses"></span></th>
              <th data-sort="winPct">Win% <span class="sort-indicator" data-indicator="winPct"></span></th>
              <th data-sort="ppd">Baseline Δ <span class="sort-indicator" data-indicator="ppd"></span></th>
              <th data-sort="avgPpd">PPD <span class="sort-indicator" data-indicator="avgPpd"></span></th>
            </tr>
          </thead>
          <tbody id="playersTableBody"></tbody>
        </table>
      </div>
    </section>

    <footer class="mt-8 text-xs opacity-70">
      <p>TaskPoints — Standings view. Read-only.</p>
    </footer>
  </div>

  <script>
    const STORAGE_KEY = "taskpoints_v1";
    const $ = id => document.getElementById(id);

    let latestState = null;
    let activeIds = new Set(["YOU"]);

    function isPlayerActive(player) {
      return !!player && player.active !== false;
    }

    function getMatchupDateKey(matchup) {
      if (!matchup) return "";
      if (matchup.dateKey) return matchup.dateKey;
      if (matchup.date) return matchup.date;
      if (matchup.dateISO && window.TaskPointsCore?.dateKey) {
        return TaskPointsCore.dateKey(matchup.dateISO);
      }
      return "";
    }

    function isMatchupRevealed(matchup, includeToday) {
      const key = getMatchupDateKey(matchup);
      if (window.TaskPointsCore?.isMatchupRevealed) {
        return TaskPointsCore.isMatchupRevealed(key, { includeToday });
      }
      if (!key) return false;
      const today = window.TaskPointsCore?.todayKey ? TaskPointsCore.todayKey() : "";
      return includeToday ? key <= today : key < today;
    }

    function loadPlayers() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return [];
        const parsed = JSON.parse(raw);
        latestState = parsed;

        let syncedState = parsed;
        let changed = false;
        if (window.TaskPointsCore?.syncDerivedPoints) {
          const derivedSync = TaskPointsCore.syncDerivedPoints(syncedState);
          syncedState = derivedSync.state;
          changed = changed || derivedSync.changed;
        }
        if (window.TaskPointsCore?.syncYouMatchups) {
          const matchupSync = TaskPointsCore.syncYouMatchups(syncedState);
          syncedState = matchupSync.state;
          changed = changed || matchupSync.changed;
        }
        if (changed) {
          if (window.TaskPointsCore?.saveAppState) {
            TaskPointsCore.saveAppState(syncedState, { storageKey: STORAGE_KEY });
          } else if (window.TaskPointsCore?.mergeAndSaveState) {
            TaskPointsCore.mergeAndSaveState(syncedState, { storageKey: STORAGE_KEY });
          } else {
            console.warn("standings save skipped; TaskPointsCore missing.");
          }
        }
        latestState = syncedState;

        const players = Array.isArray(latestState.players) ? latestState.players : [];
        const activePlayers = players.filter(isPlayerActive);
        activeIds = new Set(["YOU", ...activePlayers.map(p => p.id)]);
        return activePlayers;
      } catch (e) {
        console.error("Failed to load players from localStorage", e);
        latestState = null;
        activeIds = new Set(["YOU"]);
        return [];
      }
    }

function computeYouStats() {
  const s = latestState;

  const record = window.TaskPointsCore?.computeRecord
    ? TaskPointsCore.computeRecord(s, "YOU", { includeToday: false, allowFallback: false })
    : { wins: 0, losses: 0, games: 0, source: "unknown" };

  // 1) Prefer matchups (most accurate for W/L)
  if (record.source === "matchups") {
    const mh = s && Array.isArray(s.matchups) ? s.matchups : [];
    let games = 0;
    let totalPoints = 0;

    for (const m of mh) {
      if (!m || (m.playerAId !== "YOU" && m.playerBId !== "YOU")) continue;
      if (!activeIds.has(m.playerAId) || !activeIds.has(m.playerBId)) continue;
      if (!isMatchupRevealed(m, false)) continue;
      const aScore = Number(m.scoreA);
      const bScore = Number(m.scoreB);
      if (!Number.isFinite(aScore) || !Number.isFinite(bScore)) continue;
      const youScore = (m.playerAId === "YOU") ? aScore : bScore;
      totalPoints += youScore;
      games++;
    }

    if (!games) {
      return { games:0, wins:0, losses:0, winPct:null, avgPPD:null, ppd:null };
    }

    const avgPPD = totalPoints / games;
    const winPct = (record.wins + record.losses) ? (record.wins / (record.wins + record.losses)) * 100 : null;
    const ppd = avgPPD;

    return { games, wins: record.wins, losses: record.losses, winPct, avgPPD, ppd };
  }

  // 2) Fallback: completions-based calc (your old behavior)
  if (!s || !Array.isArray(s.completions) || !s.completions.length) {
    return { games:0, wins:0, losses:0, winPct:null, avgPPD:null, ppd:null };
  }

  const dayMap = {};
  for (const c of s.completions) {
    const day = (window.TaskPointsCore && typeof TaskPointsCore.dateKey === "function")
      ? TaskPointsCore.dateKey(c.completedAtISO || c.dateKey)
      : (c.dateKey || "");
    if (!day) continue;
    const pts = window.TaskPointsCore?.pointsForCompletion
      ? TaskPointsCore.pointsForCompletion(c)
      : Number(c.points || 0);
    if (!dayMap[day]) dayMap[day] = 0;
    dayMap[day] += pts;
  }

  const dailyTotals = Object.values(dayMap);
  if (!dailyTotals.length) {
    return { games:0, wins:0, losses:0, winPct:null, avgPPD:null, ppd:null };
  }

  const avgPPD = dailyTotals.reduce((sum, v) => sum + v, 0) / dailyTotals.length;

  let wins = 0, losses = 0;
  for (const total of dailyTotals) {
    if (total > avgPPD) wins++;
    else losses++;
  }

  const winPct = (wins + losses) ? (wins / (wins + losses)) * 100 : null;
  const ppd = avgPPD;

  return { games: dailyTotals.length, wins, losses, winPct, avgPPD, ppd };
}


    let players = loadPlayers();

    const youRow = {
      id: "YOU",
      name: "You",
      baseline: null,
      variance: null,
      momentum: null,
      risky: null,
      style: "",
      isYou: true
    };
    players = [youRow, ...players];

    let gameHistory =
      latestState && Array.isArray(latestState.gameHistory)
        ? latestState.gameHistory
        : [];

    // Standings default: Win% desc
    let sortKey = "winPct";
    let sortDir = "desc";

    function computePlayerStats(p) {
      if (p && (p.id === "YOU" || p.isYou)) {
        return computeYouStats();
      }

      const record = window.TaskPointsCore?.computeRecord
        ? TaskPointsCore.computeRecord(latestState, p.id, { includeToday: false, allowFallback: false })
        : { wins: 0, losses: 0, games: 0, source: "unknown" };

      // 1) Prefer matchup-derived results (true W/L against opponents)
      const matchups = latestState && Array.isArray(latestState.matchups)
        ? latestState.matchups
        : [];

      if (record.source === "matchups") {
        let games = 0;
        let totalPoints = 0;

        for (const m of matchups) {
          if (!m) continue;
          if (!activeIds.has(m.playerAId) || !activeIds.has(m.playerBId)) continue;
          if (!isMatchupRevealed(m, false)) continue;
          const isA = m.playerAId === p.id;
          const isB = m.playerBId === p.id;
          if (!isA && !isB) continue;

          const aScore = Number(m.scoreA);
          const bScore = Number(m.scoreB);
          if (!Number.isFinite(aScore) || !Number.isFinite(bScore)) continue;

          const playerScore = isA ? aScore : bScore;
          const oppScore    = isA ? bScore : aScore;

          games++;
          totalPoints += playerScore;
        }

        if (games) {
          const avgPPD = totalPoints / games;
          const winPct = (record.wins + record.losses)
            ? (record.wins / (record.wins + record.losses)) * 100
            : null;
          const baseline = Number.isFinite(p?.baseline)
            ? Number(p.baseline)
            : (Number(p?.baseline) || null);
          const ppd = Number.isFinite(baseline) ? (avgPPD - baseline) : null;

          return { games, wins: record.wins, losses: record.losses, winPct, avgPPD, ppd };
        }
        return { games:0, wins:0, losses:0, winPct:null, avgPPD:null, ppd:null };
      }

      // 2) Fallback: legacy gameHistory vs baseline model
      if (!Array.isArray(gameHistory) || !gameHistory.length) {
        return { games:0, wins:0, losses:0, winPct:null, avgPPD:null, ppd:null };
      }

      let games = 0;
      let totalPoints = 0;
      let wins = 0;
      let losses = 0;

      const baseline = (typeof p.baseline === "number") ? p.baseline : (Number(p.baseline) || 0);

      for (const g of gameHistory) {
        if (!activeIds.has(g.playerId)) continue;
        if (g.playerId !== p.id) continue;

        games++;
        const score = (typeof g.score === "number") ? g.score : (Number(g.score) || 0);
        totalPoints += score;

        if (baseline) {
          if (score >= baseline) wins++;
          else losses++;
        }
      }

      if (!games) {
        return { games:0, wins:0, losses:0, winPct:null, avgPPD:null, ppd:null };
      }

      const avgPPD = totalPoints / games;
      const winPct = (wins + losses) ? (wins / (wins + losses)) * 100 : null;
      const ppd = baseline ? (avgPPD - baseline) : null;

      return { games, wins: record.wins || wins, losses: record.losses || losses, winPct, avgPPD, ppd };
    }

    function getSortValue(p, key) {
      const stats = computePlayerStats(p);
      switch (key) {
        case "name":   return (p.name || "").toLowerCase();
        case "wins":   return stats.wins || 0;
        case "losses": return stats.losses || 0;
        case "winPct": return stats.winPct || 0;
        case "ppd":    return stats.ppd || 0;
        case "avgPpd": return stats.avgPPD || 0;
        default:       return 0;
      }
    }

    function escapeHtml(str) {
      if (!str && str !== 0) return "";
      return String(str).replace(/[&<>"']/g, m => ({
        "&": "&amp;",
        "<": "&lt;",
        ">": "&gt;",
        '"': "&quot;",
        "'": "&#039;"
      }[m]));
    }

    function updateSortIndicators() {
      document.querySelectorAll("[data-indicator]").forEach(span => {
        const key = span.getAttribute("data-indicator");
        span.textContent = (key === sortKey) ? (sortDir === "asc" ? "▲" : "▼") : "";
      });
    }

    function renderTable() {
      const tbody = $("playersTableBody");
      if (!tbody) return;
      tbody.innerHTML = "";

      const sorted = [...players].sort((a, b) => {
        const ak = getSortValue(a, sortKey);
        const bk = getSortValue(b, sortKey);

        if (ak == null && bk == null) return 0;
        if (ak == null) return 1;
        if (bk == null) return -1;

        if (typeof ak === "number" && typeof bk === "number") {
          return sortDir === "asc" ? ak - bk : bk - ak;
        }

        const as = String(ak).toLowerCase();
        const bs = String(bk).toLowerCase();
        if (as < bs) return sortDir === "asc" ? -1 : 1;
        if (as > bs) return sortDir === "asc" ? 1 : -1;
        return 0;
      });

      sorted.forEach(p => {
        const tr = document.createElement("tr");
        const stats = computePlayerStats(p);

        const winPctDisplay = (stats.winPct == null) ? "—" : stats.winPct.toFixed(1) + "%";
        const ppdDisplay    = (stats.ppd == null)    ? "—" : stats.ppd.toFixed(1);
        const avgPpdDisplay = (stats.avgPPD == null) ? "—" : stats.avgPPD.toFixed(1);

        tr.innerHTML = `
          <td class="pr-4">${escapeHtml(p.name || "—")}</td>
          <td>${stats.wins}</td>
          <td>${stats.losses}</td>
          <td>${winPctDisplay}</td>
          <td>${ppdDisplay}</td>
          <td>${avgPpdDisplay}</td>
        `;
        tbody.appendChild(tr);
      });

      const countLabel = $("playerCount");
      if (countLabel) {
        countLabel.textContent = players.length
          ? `${players.length} player${players.length === 1 ? "" : "s"}`
          : "No players found";
      }

      updateSortIndicators();
    }

    document.addEventListener("DOMContentLoaded", () => {
      document.querySelectorAll("th[data-sort]").forEach(th => {
        th.addEventListener("click", () => {
          const key = th.getAttribute("data-sort");
          if (!key) return;

          if (sortKey === key) sortDir = (sortDir === "asc") ? "desc" : "asc";
          else {
            sortKey = key;
            sortDir = (key === "name") ? "asc" : "desc";
          }

          renderTable();
        });
      });

      renderTable();
    });
  </script>

  <button
    class="hidden md:hidden fixed top-3 right-3 z-40 btn btn-teal rounded-full shadow-lg px-4 py-2 text-sm flex items-center gap-1"
    type="button"
    data-scroll-top
  >
    <span>⬆️</span>
    <span>Top</span>
  </button>
</body>
</html>
